!function(e){TWIR_calc={calcBest:function(e,t,s){var a=this.getBestSet(e,t);return this.result=a,s(a),a},getUsedItems:function(e,t){var s=e.items.slice(0);for(i=0;i<e.sets.length;i++)s.push.apply(s,e.sets[i].getItems());for(var a,r,n=[],i=0;i<s.length;i++)(a=Bag.getItemByItemId(s[i]))?!(r=Wear.get(a.getType()))||r&&(r.getItemBaseId()!==a.getItemBaseId()||r.getItemLevel()<a.getItemLevel())?n.push(t?a.getItemBaseId():a.getId()):n.push(t?r.getItemBaseId():r.getId()):n.push(t?parseInt(s[i]/1e3):s[i]);return n},getBestSet:function(t,s){var a,r,n,i,o,u,l=0;for(u=west.item.Calculator.filterUnavailableSets(west.storage.ItemSetManager.getAll()),a=this.getBestItems(t,s),r=new west.item.ItemSetContainer,i=0;i<a.length;i++)r.addItem(a[i].getId());for(n=this.createSubsets(u,a,t,s),e.__limitclothcalc&&n.length>500&&(n=this.createSubsets(u,a,t,s,!0),console&&console.log("using approximation...")),n=this.filterUneffectiveSets(n,t,s),(n=west.item.Calculator.fillEmptySlots(west.item.Calculator.combineSets(n),a)).push(r),i=0;i<n.length;i++){switch(n[i]=this.itemsToSets(n[i]),s){case"ms":var g=this.getValue4Container(t,n[i],s);o=this.calcSpeed([g[0],g[1]]);break;default:o=this.getValue4Container(t,n[i],s)}n[i].tmp=o,o>l&&(l=o,n[i])}return n.sort(function(e,t){return t.tmp-e.tmp})},getBestOwnItems:function(e){var t=Bag.getItemsByItemIds(TWIR.makeEmUp(e)),s=[];for(var a in Wear.wear)e.includes(Wear.wear[a].getItemBaseId())&&t.push(Wear.wear[a]);for(var r={},n=0;n<t.length;n++){var i=t[n].getType();r[i]?r[i]&&t[n].getItemLevel()>r[i].getItemLevel()&&(r[i]=t[n]):r[i]=t[n]}for(var o in r)s.push(r[o].getId());return s},countObjectKeys:function(e){var t=0;return Object&&Object.keys?t=Object.keys(e).length:jQuery.each(e,function(){t++}),t},bonus:{},mergeBonus:function(t,s,a,r){var n=this.bonus,i=new west.item.BonusExtractor({level:a||Character.level},r||0);switch(t.type){case"skill":case"attribute":n[t.type][t.name]=(n[t.type][t.name]||0)+s;break;case"fortbattle":n[t.type]["fort_"+t.name+(t.isSector?"_sector":"")]=(n[t.type]["fort_"+t.name+(t.isSector?"_sector":"")]||0)+s;break;case"job":n.job[t.job]=(n.job[t.job]||0)+s;break;case"pray":n.other_bonus[t.type]=(n.other_bonus[t.type]||0)+s;break;case"luck":case"experience":case"dollar":case"drop":n.job_bonus[t.type]=(n.job_bonus[t.type]||0)+Math.round(100*s);break;case"speed":case"regen":n.other_bonus[t.type]=(n.other_bonus[t.type]||0)+Math.round(100*s);break;case"character":this.mergeBonus(t.bonus,i.getCharacterItemValue(t),a,r);break;default:e.DEBUG&&console.log("ItemSet: unknown bonus to merge: ",t.type)}},getItemBonus:function(e,t){var s=e.item_level,a=this.bonus,r=new west.item.BonusExtractor({level:t||Character.level},s||0);if(e.speed&&(a.other_bonus.ms=(a.other_bonus.ms||0)+Math.round(1/e.speed*100-100)),e instanceof west.item.Weapon&&"left_arm"===e.type){var n=e.getDamage(Character);a.damage[0]=n.min,a.damage[1]=n.max}if("object"==typeof e.bonus.attributes&&this.countObjectKeys(e.bonus.attributes)>0)for(var i in e.bonus.attributes)e.bonus.attributes[i]&&(a.attribute[i]=(a.attribute[i]||0)+e.bonus.attributes[i]);if("object"==typeof e.bonus.skills&&this.countObjectKeys(e.bonus.skills)>0)for(var i in e.bonus.skills)e.bonus.skills[i]&&(a.skill[i]=(a.skill[i]||0)+e.bonus.skills[i]);if(e.bonus.item.length)for(i=0;i<e.bonus.item.length;i++){a=r.getExportValue(e.bonus.item[i]);e instanceof west.item.Weapon&&"damage"===a.key||this.mergeBonus(e.bonus.item[i],e.bonus.item[i].value,t,s)}},exportFullBonus:function(e,t,s,a){if(!$.isEmptyObject(e)){if(this.bonus={attribute:{},skill:{},job:{},job_bonus:{},other_bonus:{},fortbattle:{},damage:[]},t){for(var r=[],n=0;n<e.sets.length;n++){for(var i=west.storage.ItemSetManager.get(e.sets[n].key).getMergedStages(e.sets[n].items.length),o=0;o<i.length;o++){var u=i[o];bonus=this.mergeBonus(u,u.value,a)}for(var l=0;l<e.sets[n].items.length;l++)bonus=this.getItemBonus(ItemManager.get(e.sets[n].items[l]),a),r.push(e.sets[n].items[l])}for(var g=0;g<e.items.length;g++)r.includes(e.items[g]*(s?1e3:1))||this.getItemBonus(ItemManager.get(e.items[g]*(s?1e3:1)),a)}else{for(i=west.storage.ItemSetManager.get(e.key).getMergedStages(e.items.length),o=0;o<i.length;o++){u=i[o];this.mergeBonus(u,u.value,a)}for(l=0;l<e.items.length;l++)this.getItemBonus(ItemManager.get(e.items[l]*(s?1e3:1)),a)}return this.bonus}},getAdditionalBonus:function(e,t){var s=new west.item.BonusExtractor(Character,t);switch("character"===e.type?(value=s.getCharacterItemValue(e),(e=e.bonus).type in s.keyDescMapping&&(value=Math.round(100*value))):e.type in s.keyDescMapping?(value=s.getValue(e),value=Math.round(100*value)):value=s.getValue(e),e.type){case"fortbattle":key="fort_"+e.name+(e.isSector?"_sector":"");break;case"job":key=e.type+(e.job&&"all"===e.job?"":"_"+e.job);break;default:key=e.type}return{[key]:value}},getPointAddition:function(e,t,s){var a=this;return"character"==e.type&&"level"==e.key?a.getPointAddition(e.bonus,function(t){return a.getRoundedValue(t*Character.level,e.roundingMethod)}.bind(this),e.roundingMethod):0},getRoundedValue:function(e,t){switch(t){case"round":return Math.round(e);case"ceil":return Math.ceil(e);case"floatceil":return Math.ceil(100*e)/100;case"floor":return Math.floor(e);default:return e}},getValue:function(e,t,s,a){var r,n,i,o,u,l=a?{}:0,g={},c={};if([185147e3,185148e3,185149e3,18515e4,185151e3,185152e3,41999e3,50106e3,48999e3].includes(t.getId()))return l;var h={};for(r in e)e[r]&&(attr=CharacterSkills.getAttributeKey4Skill(r),g[attr]=(g[attr]||0)+1);for(attr in t.bonus.attributes)if(g[attr])for(n=CharacterSkills.getSkillKeys4Attribute(attr),i=0;i<n.length;i++)e[n[i]]&&(c[n[i]]=t.bonus.attributes[attr]);if(t.hasItemBonus())for(o=new west.item.BonusExtractor(Character,t.getItemLevel()),i=0;i<t.bonus.item.length;i++){u=o.getAffectedSkills(t.bonus.item[i]);var m=this.getAdditionalBonus(t.bonus.item[i],t.getItemLevel());for(r in u)h[r]||(h[r]=0),h[r]+=u[r],r in e&&(a?l[r]=(l[r]||0)+e[r]*u[r]:l+=e[r]*u[r]);for(special in m)special in e&&(special in u||(a?l[special]=(l[special]||0)+e[special]*m[special]:l+=e[special]*m[special]));a||(l+=this.getPointAddition(t.bonus.item[i]))}if(t instanceof west.item.Weapon){var d=t.getDamage(Character),f=(d.min+d.max)/2;"right_arm"===t.type&&(h.duel_dmg=f),"left_arm"===t.type&&(h.fort_dmg=[d.min,d.max])}for(r in e)(t.bonus.skills[r]||c[r])&&(a?l[r]=(l[r]||0)+e[r]*((t.bonus.skills[r]||0)+(c[r]||0)):l+=e[r]*((t.bonus.skills[r]||0)+(c[r]||0))),t.speed&&"ride"===r&&"ms"===s&&(a?l[r]=(l[r]||0)+Math.round(Character.defaultSpeed/(Character.defaultSpeed*t.speed)*100-100):l+=Math.round(Character.defaultSpeed/(Character.defaultSpeed*t.speed)*100-100));return t.usebonus&&t.action&&(l=a?{}:0),l},calcSpeed:function(e){var t=(100+e[0]+CharacterSkills.getSkill("ride").points)*(1+e[1]/100);return e[0]||e[1]||(t=0),t},getValue4Set:function(e,t,s,a){var r=0,n=0,i=0;switch(s){case"ms":var o=this.getSetValue({speed:1,ride:1},t,s,!0);n+=o.speed||0,i+=o.ride||0;break;default:r+=this.getSetValue(e,t,s)}var u=t.items;a&&(u=TWIR.makeEmUp(u,!0));for(var l=0;l<u.length;l++)switch(s){case"ms":var g=this.getValue({speed:1,ride:1},ItemManager.get(u[l]),s,!0);if(n+=g.speed||0,i+=g.ride||0,l==u.length-1)return this.calcSpeed([i,n]);break;default:if(r+=this.getValue(e,ItemManager.get(u[l]),s),l==u.length-1)return r}},getSetValue:function(e,t,s,a){var r,n,i,o,u=a?{}:0,l=t.getMergedStages(),g={};for(i=new west.item.BonusExtractor(Character),n=0;n<l.length;n++){o=i.getAffectedSkills(l[n]);var c=this.getAdditionalBonus(l[n],null);for(r in o)g[r]||(g[r]=0),g[r]+=o[r],r in e&&(a?u[r]=(u[r]||0)+e[r]*o[r]:u+=e[r]*o[r]);for(special in c)special in e&&(special in o||(a?u[special]=(u[special]||0)+e[special]*c[special]:u+=e[special]*c[special]));a||(u+=this.getPointAddition(l[n]))}for(r in e);return u},getValue4Container:function(e,t,s){var a,r=0,n=0,i=0,o=t.getItems();for(a=0;a<o.length;a++)switch(s){case"ms":var u=this.getValue({speed:1,ride:1},ItemManager.get(o[a]),s,!0);n+=u.speed||0,i+=u.ride||0;break;default:r+=this.getValue(e,ItemManager.get(o[a]),s)}switch(s){case"ms":var l=this.getSetValue4Container(e,t,s);return n+=l[1],[i+=l[0],n];default:return r+=this.getSetValue4Container(e,t,s)}},getSetValue4Container:function(e,t,s){var a,r=0,n=0,i=0;for(a=0;a<t.sets.length;a++)switch(s){case"ms":var o=this.getSetValue({speed:1,ride:1},t.sets[a],s,!0);if(n+=o.speed||0,i+=o.ride||0,a==t.sets.length-1)return[i,n];break;default:if(r+=this.getSetValue(e,t.sets[a],s),a==t.sets.length-1)return r}},itemsToSets:function(e){for(var t={},s=e.items,a=[],r=0;r<s.length;r++){var n=ItemManager.get(s[r]);if(n.set)if(t[n.set])t[n.set].items.push(n.getId());else{var i=west.storage.ItemSetManager.get(n.set);t[n.set]=new west.item.ItemSet({key:i.key,items:[n.getId()],bonus:i.bonus})}else a.push(n.getId())}for(var o in t)-1===e.sets.findIndex(function(e){return e.key===o})&&e.sets.push(t[o]);return e.items=a,e},getBestItems:function(e,t){var s={},a=[],r=0,n=Bag.getItemsIdsByBaseItemIds(),i=this;return west.common.forEach(n,function(a,n){var o=ItemManager.get(a[0]),u=o.getType(),l=0,g=0;switch(t){case"ms":var c=i.getValue({speed:1,ride:1},o,t,!0);l=c.speed||0,g=c.ride||0,r=g;break;default:r=i.getValue(e,o,t)}s[u]=s[u]||[],r&&o.wearable()&&s[u].push({item:o,id:o.getId(),base_id:n,value:r,speed:l})}),west.common.forEach(s,function(r,n){var o=Wear.get(n),u=0;if(o){switch(o=ItemManager.get(o.getId()),wear_rideBoni=0,wear_speedBoni=0,t){case"ms":var l=i.getValue({speed:1,ride:1},o,t,!0);wear_speedBoni=l.speed||0,wear_rideBoni=l.ride||0,u=wear_rideBoni;break;default:u=i.getValue(e,o,t)}r.push({item:o,id:o.getId(),base_id:o.getItemBaseId(),value:u,speed:wear_speedBoni})}if(s[n]=r.sort(function(e,s){switch(t){case"ms":return e.value||e.speed?s.value||s.speed?s.speed-e.speed||s.value-e.value:-1:1;default:return s.value-e.value}}),s[n].length){var g=s[n][0];if("right_arm"===n){var c=s[n].filter(function(e){return e.value===g.value});a.push(c.length?c[0].item:g.item)}else a.push(g.item)}}),a},beatsBestItems:function(e,t,s,a){var r,n=e.getUsedSlots(),i=0,o=0,u=0;for(r=0;r<t.length;r++)if(-1!==n.indexOf(t[r].getType()))switch(a){case"ms":var l=this.getValue({speed:1,ride:1},t[r],a,!0);o+=l.speed||0,u+=l.ride||0;break;default:i+=this.getValue(s,t[r],a)}switch(a){case"ms":i=this.calcSpeed([u,o])}return this.getValue4Set(s,e,a)>i},itemsCombineable:function(e){var t,s,a={};for(t=0;t<e.length;t++){if(!0===a[s=ItemManager.get(e[t]).type])return!1;a[s]=!0}return!0},createCombinations:function(e,t){var s,a,r,n,i;if(t>e.length||t<=0)return[];if(t==e.length)return[e];if(1==t){for(r=[],s=0;s<e.length;s++)r.push([e[s]]);return r}for(r=[],s=0;s<e.length-t+1;s++)for(n=e.slice(s,s+1),i=this.createCombinations(e.slice(s+1),t-1),a=0;a<i.length;a++)r.push(n.concat(i[a]));return r},sortSetItems:function(e,t,s){var a=ItemManager.get,r=this;t.items.sort(function(t,n){return r.getValue(e,a(n),s)-r.getValue(e,a(t),s)})},weapon:"shot",filterWeapons:function(e){for(var t,s=[],a=0;a<e.length;a++){var r=ItemManager.get(e[a]);"right_arm"===r.type&&s.push(e[a]),"right_arm"===r.type&&r.sub_type!==this.weapon&&(t=e[a])}return!s.length||s.length<2?e:e.filter(function(e){return e!==t})},createSubsets:function(e,t,s,a,r){var n,i,o,u,l,g,c,h=[];for(n=0;n<e.length;n++)for(i=e[n],r&&"ms"!==a&&this.sortSetItems(s,i,a),o=i.items.length;o>0;o--)if(i.bonus.hasOwnProperty(o)){var m=this.filterWeapons(i.items);for(l=0,g=(u=r&&"ms"!==a?[i.items.slice(0,o)]:this.createCombinations(m,o)).length;l<g;l++)this.itemsCombineable(u[l])&&(c=new west.item.ItemSet({key:i.key,items:u[l],bonus:i.bonus}),this.beatsBestItems(c,t,s,a)&&h.push(c))}return h},filterUneffectiveSets:function(e,t,s){var a,r,n,i,o=[],u={},l=0,g=0;for(a=0;a<e.length;a++){switch(s){case"ms":var c=this.getSetValue({speed:1,ride:1},e[a],s,!0);l=c.speed||0,g=c.ride||0,n=this.calcSpeed([g,l]);break;default:n=this.getSetValue(t,e[a],s)}n<1||(u[r=JSON.stringify(e[a].getUsedSlots().sort())]?(i=this.getValue4Set(t,e[a],s),this.getValue4Set(t,u[r],s)<i&&(u[r]=e[a])):u[r]=e[a])}for(a in u)o.push(u[a]);return o}}}(window);
