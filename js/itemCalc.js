!function(e){TWIR_calc={calcBest:function(e,t,a){var r=TWIR_calc.getBestSet(e,t);return TWIR_calc.result=r,a(r),r},getUsedItems:function(e,t){var a=e.items.slice(0);for(l=0;l<e.sets.length;l++)a.push.apply(a,e.sets[l].getItems());for(var r,s,n=[],l=0;l<a.length;l++)(r=Bag.getItemByItemId(a[l]))?!(s=Wear.get(r.getType()))||s&&(s.getItemBaseId()!==r.getItemBaseId()||s.getItemLevel()<r.getItemLevel())?n.push(t?r.getItemBaseId():r.getId()):n.push(t?s.getItemBaseId():s.getId()):n.push(t?parseInt(a[l]/1e3):a[l]);return n},getBestSet:function(t,a){var r,s,n,l,i,c,o=0;for(c=west.item.Calculator.filterUnavailableSets(west.storage.ItemSetManager.getAll()),r=TWIR_calc.getBestItems(t,a),s=new west.item.ItemSetContainer,l=0;l<r.length;l++)s.addItem(r[l].getId());for(n=TWIR_calc.createSubsets(c,r,t,a),e.__limitclothcalc&&n.length>500&&(n=TWIR_calc.createSubsets(c,r,t,a,!0),console&&console.log("using approximation...")),n=TWIR_calc.filterUneffectiveSets(n,t,a),(n=west.item.Calculator.fillEmptySlots(west.item.Calculator.combineSets(n),r)).push(s),l=0;l<n.length;l++){switch(n[l]=TWIR_calc.itemsToSets(n[l]),a){case"ms":var u=TWIR_calc.getValue4Container(t,n[l],a);i=TWIR_calc.calcSpeed([u[0],u[1]]);break;default:i=TWIR_calc.getValue4Container(t,n[l],a)}n[l].tmp=i,i>o&&(o=i,n[l])}return n.sort(function(e,t){return t.tmp-e.tmp})},getBestOwnItems:function(e){var t=Bag.getItemsByItemIds(TWIR.makeEmUp(e)),a=[];for(var r in Wear.wear)e.includes(Wear.wear[r].getItemBaseId())&&t.push(Wear.wear[r]);for(var s={},n=0;n<t.length;n++){var l=t[n].getType();s[l]?s[l]&&t[n].getItemLevel()>s[l].getItemLevel()&&(s[l]=t[n]):s[l]=t[n]}for(var i in s)a.push(s[i].getId());return a},countObjectKeys:function(e){var t=0;return Object&&Object.keys?t=Object.keys(e).length:jQuery.each(e,function(){t++}),t},bonus:{},mergeBonus:function(t,a,r,s){var n=TWIR_calc.bonus,l=new west.item.BonusExtractor({level:r||Character.level},s||0);switch(t.type){case"skill":case"attribute":n[t.type][t.name]=(n[t.type][t.name]||0)+a;break;case"fortbattle":n[t.type]["fort_"+t.name+(t.isSector?"_sector":"")]=(n[t.type]["fort_"+t.name+(t.isSector?"_sector":"")]||0)+a;break;case"job":n.job[t.job]=(n.job[t.job]||0)+a;break;case"pray":n.other_bonus[t.type]=(n.other_bonus[t.type]||0)+a;break;case"luck":case"experience":case"dollar":case"drop":n.job_bonus[t.type]=(n.job_bonus[t.type]||0)+Math.round(100*a);break;case"speed":case"regen":n.other_bonus[t.type]=(n.other_bonus[t.type]||0)+Math.round(100*a);break;case"character":TWIR_calc.mergeBonus(t.bonus,l.getCharacterItemValue(t),r,s);break;default:e.DEBUG&&console.log("ItemSet: unknown bonus to merge: ",t.type)}},getItemBonus:function(e,t){var a=e.item_level,r=TWIR_calc.bonus,s=new west.item.BonusExtractor({level:t||Character.level},a||0);if(e.speed&&(r.other_bonus.ms=(r.other_bonus.ms||0)+Math.round(1/e.speed*100-100)),e instanceof west.item.Weapon&&"left_arm"===e.type){var n=e.getDamage(Character);r.damage[0]=n.min,r.damage[1]=n.max}if("object"==typeof e.bonus.attributes&&TWIR_calc.countObjectKeys(e.bonus.attributes)>0)for(var l in e.bonus.attributes)e.bonus.attributes[l]&&(r.attribute[l]=(r.attribute[l]||0)+e.bonus.attributes[l]);if("object"==typeof e.bonus.skills&&TWIR_calc.countObjectKeys(e.bonus.skills)>0)for(var l in e.bonus.skills)e.bonus.skills[l]&&(r.skill[l]=(r.skill[l]||0)+e.bonus.skills[l]);if(e.bonus.item.length)for(l=0;l<e.bonus.item.length;l++){r=s.getExportValue(e.bonus.item[l]);e instanceof west.item.Weapon&&"damage"===r.key||TWIR_calc.mergeBonus(e.bonus.item[l],e.bonus.item[l].value,t,a)}},exportFullBonus:function(e,t,a,r){if(!$.isEmptyObject(e)){if(TWIR_calc.bonus={attribute:{},skill:{},job:{},job_bonus:{},other_bonus:{},fortbattle:{},damage:[]},t){for(var s=[],n=0;n<e.sets.length;n++){for(var l=west.storage.ItemSetManager.get(e.sets[n].key).getMergedStages(e.sets[n].items.length),i=0;i<l.length;i++){var c=l[i];bonus=TWIR_calc.mergeBonus(c,c.value,r)}for(var o=0;o<e.sets[n].items.length;o++)bonus=TWIR_calc.getItemBonus(ItemManager.get(e.sets[n].items[o]),r),s.push(e.sets[n].items[o])}for(var u=0;u<e.items.length;u++)s.includes(e.items[u]*(a?1e3:1))||TWIR_calc.getItemBonus(ItemManager.get(e.items[u]*(a?1e3:1)),r)}else{for(l=west.storage.ItemSetManager.get(e.key).getMergedStages(e.items.length),i=0;i<l.length;i++){c=l[i];TWIR_calc.mergeBonus(c,c.value,r)}for(o=0;o<e.items.length;o++)TWIR_calc.getItemBonus(ItemManager.get(e.items[o]*(a?1e3:1)),r)}return TWIR_calc.bonus}},getAdditionalBonus:function(e,t){var a=new west.item.BonusExtractor(Character,t);switch("character"===e.type?(value=a.getCharacterItemValue(e),(e=e.bonus).type in a.keyDescMapping&&(value=Math.round(100*value))):e.type in a.keyDescMapping?(value=a.getValue(e),value=Math.round(100*value)):value=a.getValue(e),e.type){case"fortbattle":key="fort_"+e.name+(e.isSector?"_sector":"");break;case"job":key=e.type+(e.job&&"all"===e.job?"":"_"+e.job);break;default:key=e.type}return{[key]:value}},getPointAddition:function(e,t,a){var r=TWIR_calc;return"character"==e.type&&"level"==e.key?r.getPointAddition(e.bonus,function(t){return r.getRoundedValue(t*Character.level,e.roundingMethod)}.bind(this),e.roundingMethod):0},getRoundedValue:function(e,t){switch(t){case"round":return Math.round(e);case"ceil":return Math.ceil(e);case"floatceil":return Math.ceil(100*e)/100;case"floor":return Math.floor(e);default:return e}},getValue:function(e,t,a,r){var s,n,l,i,c,o=r?{}:0,u={},g={};if([185147e3,185148e3,185149e3,18515e4,185151e3,185152e3,41999e3,50106e3,48999e3].includes(t.getId()))return o;var m={};for(s in e)e[s]&&(attr=CharacterSkills.getAttributeKey4Skill(s),u[attr]=(u[attr]||0)+1);for(attr in t.bonus.attributes)if(u[attr])for(n=CharacterSkills.getSkillKeys4Attribute(attr),l=0;l<n.length;l++)e[n[l]]&&(g[n[l]]=t.bonus.attributes[attr]);if(t.hasItemBonus())for(i=new west.item.BonusExtractor(Character,t.getItemLevel()),l=0;l<t.bonus.item.length;l++){c=i.getAffectedSkills(t.bonus.item[l]);var d=TWIR_calc.getAdditionalBonus(t.bonus.item[l],t.getItemLevel());for(s in c)m[s]||(m[s]=0),m[s]+=c[s],s in e&&(r?o[s]=(o[s]||0)+e[s]*c[s]:o+=e[s]*c[s]);for(special in d)special in e&&(special in c||(r?o[special]=(o[special]||0)+e[special]*d[special]:o+=e[special]*d[special]));r||(o+=TWIR_calc.getPointAddition(t.bonus.item[l]))}if(t instanceof west.item.Weapon){var f=t.getDamage(Character),p=(f.min+f.max)/2;"right_arm"===t.type&&(m.duel_dmg=p),"left_arm"===t.type&&(m.fort_dmg=[f.min,f.max])}for(s in e)(t.bonus.skills[s]||g[s])&&(r?o[s]=(o[s]||0)+e[s]*((t.bonus.skills[s]||0)+(g[s]||0)):o+=e[s]*((t.bonus.skills[s]||0)+(g[s]||0))),t.speed&&"ride"===s&&"ms"===a&&(r?o[s]=(o[s]||0)+Math.round(Character.defaultSpeed/(Character.defaultSpeed*t.speed)*100-100):o+=Math.round(Character.defaultSpeed/(Character.defaultSpeed*t.speed)*100-100));return t.usebonus&&t.action&&(o=r?{}:0),o},calcSpeed:function(e){var t=(100+e[0]+CharacterSkills.getSkill("ride").points)*(1+e[1]/100);return e[0]||e[1]||(t=0),t},getValue4Set:function(e,t,a,r){var s=0,n=0,l=0;switch(a){case"ms":var i=TWIR_calc.getSetValue({speed:1,ride:1},t,a,!0);n+=i.speed||0,l+=i.ride||0;break;default:s+=TWIR_calc.getSetValue(e,t,a)}var c=t.items;r&&(c=TWIR.makeEmUp(c,!0));for(var o=0;o<c.length;o++)switch(a){case"ms":var u=TWIR_calc.getValue({speed:1,ride:1},ItemManager.get(c[o]),a,!0);if(n+=u.speed||0,l+=u.ride||0,o==c.length-1)return TWIR_calc.calcSpeed([l,n]);break;default:if(s+=TWIR_calc.getValue(e,ItemManager.get(c[o]),a),o==c.length-1)return s}},getSetValue:function(e,t,a,r){var s,n,l,i,c=r?{}:0,o=t.getMergedStages(),u={};for(l=new west.item.BonusExtractor(Character),n=0;n<o.length;n++){i=l.getAffectedSkills(o[n]);var g=TWIR_calc.getAdditionalBonus(o[n],null);for(s in i)u[s]||(u[s]=0),u[s]+=i[s],s in e&&(r?c[s]=(c[s]||0)+e[s]*i[s]:c+=e[s]*i[s]);for(special in g)special in e&&(special in i||(r?c[special]=(c[special]||0)+e[special]*g[special]:c+=e[special]*g[special]));r||(c+=TWIR_calc.getPointAddition(o[n]))}for(s in e);return c},getValue4Container:function(e,t,a){var r,s=0,n=0,l=0,i=t.getItems();for(r=0;r<i.length;r++)switch(a){case"ms":var c=TWIR_calc.getValue({speed:1,ride:1},ItemManager.get(i[r]),a,!0);n+=c.speed||0,l+=c.ride||0;break;default:s+=TWIR_calc.getValue(e,ItemManager.get(i[r]),a)}switch(a){case"ms":var o=TWIR_calc.getSetValue4Container(e,t,a);return n+=o[1],[l+=o[0],n];default:return s+=TWIR_calc.getSetValue4Container(e,t,a)}},getSetValue4Container:function(e,t,a){var r,s=0,n=0,l=0;for(r=0;r<t.sets.length;r++)switch(a){case"ms":var i=TWIR_calc.getSetValue({speed:1,ride:1},t.sets[r],a,!0);if(n+=i.speed||0,l+=i.ride||0,r==t.sets.length-1)return[l,n];break;default:if(s+=TWIR_calc.getSetValue(e,t.sets[r],a),r==t.sets.length-1)return s}},itemsToSets:function(e){for(var t={},a=e.items,r=[],s=0;s<a.length;s++){var n=ItemManager.get(a[s]);if(n.set)if(t[n.set])t[n.set].items.push(n.getId());else{var l=west.storage.ItemSetManager.get(n.set);t[n.set]=new west.item.ItemSet({key:l.key,items:[n.getId()],bonus:l.bonus})}else r.push(n.getId())}for(var i in t)-1===e.sets.findIndex(function(e){return e.key===i})&&e.sets.push(t[i]);return e.items=r,e},getBestItems:function(e,t){var a={},r=[],s=0,n=Bag.getItemsIdsByBaseItemIds(),l=TWIR_calc;return west.common.forEach(n,function(r,n){var i=ItemManager.get(r[0]),c=i.getType(),o=0,u=0;switch(t){case"ms":var g=l.getValue({speed:1,ride:1},i,t,!0);o=g.speed||0,u=g.ride||0,s=u;break;default:s=l.getValue(e,i,t)}a[c]=a[c]||[],s&&i.wearable()&&a[c].push({item:i,id:i.getId(),base_id:n,value:s,speed:o})}),west.common.forEach(a,function(s,n){var i=Wear.get(n),c=0;if(i){switch(i=ItemManager.get(i.getId()),wear_rideBoni=0,wear_speedBoni=0,t){case"ms":var o=l.getValue({speed:1,ride:1},i,t,!0);wear_speedBoni=o.speed||0,wear_rideBoni=o.ride||0,c=wear_rideBoni;break;default:c=l.getValue(e,i,t)}s.push({item:i,id:i.getId(),base_id:i.getItemBaseId(),value:c,speed:wear_speedBoni})}if(a[n]=s.sort(function(e,a){switch(t){case"ms":return e.value||e.speed?a.value||a.speed?a.speed-e.speed||a.value-e.value:-1:1;default:return a.value-e.value}}),a[n].length){var u=a[n][0];if("right_arm"===n){var g=a[n].filter(function(e){return e.value===u.value});r.push(g.length?g[0].item:u.item)}else r.push(u.item)}}),r},beatsBestItems:function(e,t,a,r){var s,n=e.getUsedSlots(),l=0,i=0,c=0;for(s=0;s<t.length;s++)if(-1!==n.indexOf(t[s].getType()))switch(r){case"ms":var o=TWIR_calc.getValue({speed:1,ride:1},t[s],r,!0);i+=o.speed||0,c+=o.ride||0;break;default:l+=TWIR_calc.getValue(a,t[s],r)}switch(r){case"ms":l=TWIR_calc.calcSpeed([c,i])}return TWIR_calc.getValue4Set(a,e,r)>l},itemsCombineable:function(e){var t,a,r={};for(t=0;t<e.length;t++){if(!0===r[a=ItemManager.get(e[t]).type])return!1;r[a]=!0}return!0},createCombinations:function(e,t){var a,r,s,n,l;if(t>e.length||t<=0)return[];if(t==e.length)return[e];if(1==t){for(s=[],a=0;a<e.length;a++)s.push([e[a]]);return s}for(s=[],a=0;a<e.length-t+1;a++)for(n=e.slice(a,a+1),l=TWIR_calc.createCombinations(e.slice(a+1),t-1),r=0;r<l.length;r++)s.push(n.concat(l[r]));return s},sortSetItems:function(e,t,a){var r=ItemManager.get,s=TWIR_calc;t.items.sort(function(t,n){return s.getValue(e,r(n),a)-s.getValue(e,r(t),a)})},weapon:"shot",filterWeapons:function(e){for(var t,a=[],r=0;r<e.length;r++){var s=ItemManager.get(e[r]);"right_arm"===s.type&&a.push(e[r]),"right_arm"===s.type&&s.sub_type!==TWIR_calc.weapon&&(t=e[r])}return!a.length||a.length<2?e:e.filter(function(e){return e!==t})},createSubsets:function(e,t,a,r,s){var n,l,i,c,o,u,g,m=[];for(n=0;n<e.length;n++)for(l=e[n],s&&"ms"!==r&&TWIR_calc.sortSetItems(a,l,r),i=l.items.length;i>0;i--)if(l.bonus.hasOwnProperty(i)){var d=TWIR_calc.filterWeapons(l.items);for(o=0,u=(c=s&&"ms"!==r?[l.items.slice(0,i)]:TWIR_calc.createCombinations(d,i)).length;o<u;o++)TWIR_calc.itemsCombineable(c[o])&&(g=new west.item.ItemSet({key:l.key,items:c[o],bonus:l.bonus}),TWIR_calc.beatsBestItems(g,t,a,r)&&m.push(g))}return m},filterUneffectiveSets:function(e,t,a){var r,s,n,l,i=[],c={},o=0,u=0;for(r=0;r<e.length;r++){switch(a){case"ms":var g=TWIR_calc.getSetValue({speed:1,ride:1},e[r],a,!0);o=g.speed||0,u=g.ride||0,n=TWIR_calc.calcSpeed([u,o]);break;default:n=TWIR_calc.getSetValue(t,e[r],a)}n<1||(c[s=JSON.stringify(e[r].getUsedSlots().sort())]?(l=TWIR_calc.getValue4Set(t,e[r],a),TWIR_calc.getValue4Set(t,c[s],a)<l&&(c[s]=e[r])):c[s]=e[r])}for(r in c)i.push(c[r]);return i}}}(window);
