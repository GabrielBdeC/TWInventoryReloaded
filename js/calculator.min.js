window,TWIR_calc={_memo:{},getPreset:function(){return{skills:{},primary:void 0,secondary:void 0,mode:"exact",weapon:"none",side:"attack",level:Character.level,reset:function(){Object.assign(this,TWIR_calc.getPreset())}}},calcBest:function(e){var t=this;this.getBestSet(function(r){t.primary=r,t.result=t.reduceResults(r),t.preset.secondary&&t.sortResult(t.preset.secondary),e(t.result)})},sortResult:function(e){this.result.sort(function(t,r){return t.stats[e]?r.stats[e]?r.stats[e]-t.stats[e]||r.tmp-t.tmp:1:-1})},getUsedItems:function(e,t){if("object"!=typeof e)return new Array;var r=e.items.slice(0);for(n=0;n<e.sets.length;n++)r.push.apply(r,e.sets[n].getItems());for(var s,a,i=[],n=0;n<r.length;n++)(s=Bag.getItemByItemId(r[n]))?!(a=Wear.get(s.getType()))||a&&(a.getItemBaseId()!==s.getItemBaseId()||a.getItemLevel()<s.getItemLevel())?i.push(t?s.getItemBaseId():s.getId()):i.push(t?a.getItemBaseId():a.getId()):i.push(t?parseInt(r[n]/1e3):r[n]);return i},getBestSet:function(e){var t=this,r=this.preset.primary;if(!r&&$.isEmptyObject(this.preset.skills))return new Array;var s,a,i,n,l,o,u=0;for(o=west.item.Calculator.filterUnavailableSets(west.storage.ItemSetManager.getAll()),s=this.getBestItems(),a=new west.item.ItemSetContainer,n=0;n<s.length;n++)a.addItem(s[n].getId());for((i=this.createSubsets(o,s)).length>500&&(i=this.createSubsets(o,s,!0),console.log("using approximation...")),i=this.filterUneffectiveSets(i),(i=west.item.Calculator.fillEmptySlots(west.item.Calculator.combineSets(i),s)).push(a),n=0;n<i.length;n++){i[n]=this.itemsToSets(i[n]);var c=this.getValue4Container(i[n],!0);l=this.calcByFormula(c),i[n].tmp=l,l>u&&(u=l,i[n]),(r||"ms"==r)&&(i[n].stats={},$.each(["fort_offense","fort_defense","fort_damage","fort_resistance","fort_hp"],function(e,r){i[n].stats[r]=t.calcByFormula(c,r)}))}return e(i),i},getBestOwnItems:function(e){var t=Bag.getItemsByItemIds(TWIR.makeEmUp(e)),r=[];for(var s in Wear.wear)e.includes(Wear.wear[s].getItemBaseId())&&t.push(Wear.wear[s]);for(var a={},i=0;i<t.length;i++){var n=t[i].getType();a[n]?a[n]&&t[i].getItemLevel()>a[n].getItemLevel()&&(a[n]=t[i]):a[n]=t[i]}for(var l in a)r.push(a[l].getId());return r},countObjectKeys:function(e){var t=0;return Object&&Object.keys?t=Object.keys(e).length:jpreset.each(e,function(){t++}),t},exportFullBonus:function(e,t,r,s){if(!$.isEmptyObject(e)){var a={};if(t)a=this.getValue4Container(e,!1,s);else{var i=west.storage.ItemSetManager.get(e.key);a=this.getSetValue(i,!1,s);for(var n=e.items,l=0;l<n.length;l++){var o=this.getItemValue(ItemManager.get(n[l]*(r?1e3:1)),!1,s);for(var u in o)a[u]||(a[u]=0),a[u]+=o[u]}}return this.mergeBonus(a)}},mergeBonus:function(e){var t=["experience","dollar","drop","luck"],r={skill:{},attribute:{},fortbattle:{},job:{},income:{},other:{}};for(var s in e)switch(!0){case-1!==s.indexOf("job_"):r.job[s.replace(/\D/g,"")]=e[s];break;case"job"===s:r.job[s]=e[s];break;case-1!==s.indexOf("fort_"):r.fortbattle[s]=e[s];break;case CharacterSkills.allSkillKeys.includes(s):r.skill[s]=e[s];break;case CharacterSkills.allAttrKeys.includes(s):r.attribute[s]=e[s];break;case t.includes(s):r.income[s]=e[s];break;default:r.other[s]=e[s]}return r},getAdditionalBonus:function(e,t,r){r=r||(this.preset.level?this.preset.level:Character.level);var s=new west.item.BonusExtractor({level:r},t);switch("character"===e.type?(value=s.getCharacterItemValue(e),(e=e.bonus).type in s.keyDescMapping&&(value=Math.round(100*value))):e.type in s.keyDescMapping?(value=s.getValue(e),value=Math.round(100*value)):value=s.getValue(e),e.type){case"skill":case"attribute":key=e.name;break;case"fortbattle":key="fort_"+e.name+(e.isSector?"_sector":"");break;case"job":key=e.type+(e.job&&"all"===e.job?"":"_"+e.job);break;default:key=e.type}return{key:key,value:value}},getItemValue:function(e,t,r){r=r||(this.preset.level?this.preset.level:Character.level);var s,a,i=this.preset.skills,n=new west.item.BonusExtractor({level:r},e.getItemLevel()),l={},o=[],u=e.short+"_"+e.getItemLevel()+"_"+r+"_"+JSON.stringify(this.preset)+"_"+t;if(this._memo[u])return this._memo[u];function c(e,t){"damage"!==e&&(l[e]=l[e]||0,l[e]+=t)}function f(e,t){return!!CharacterSkills.allAttrKeys.includes(e)||!t&&!!CharacterSkills.allSkillKeys.includes(e)}if(e.speed&&c("ms",Math.round(1/e.speed*100-100)),e instanceof west.item.Weapon&&(c(e.type+"_damage_min",e.getDamage({level:r}).min),c(e.type+"_damage_max",e.getDamage({level:r}).max)),"object"==typeof e.bonus.attributes&&this.countObjectKeys(e.bonus.attributes)>0)for(var m in e.bonus.attributes)if(t&&e.bonus.attributes[m]){m in i&&c(m,e.bonus.attributes[m]),o=CharacterSkills.getSkillKeys4Attribute(m);for(var h=0;h<o.length;h++)c(o[h],e.bonus.attributes[m])}else!t&&e.bonus.attributes[m]&&c(m,e.bonus.attributes[m]);if("object"==typeof e.bonus.skills&&this.countObjectKeys(e.bonus.skills)>0)for(var m in e.bonus.skills)e.bonus.skills[m]&&c(m,e.bonus.skills[m]);if(e.bonus.item.length)for(m=0;m<e.bonus.item.length;m++){if(s=n.getAffectedSkills(e.bonus.item[m]),a=this.getAdditionalBonus(e.bonus.item[m],e.getItemLevel(),r),t)for(skill in s)c(skill,s[skill]);(!t||!f(a.key)||t&&f(a.key,!0)&&a.key in i)&&c(a.key,a.value)}return(e.usebonus||e.action)&&(l={}),this._memo[u]=l,l},reduceResults:function(e){if(!$.isArray(e)||!e.length)return new Array;var t=[];function r(e,t){return e-t==0?0:100*Math.abs((e-t)/t)}e.sort(function(e,t){return t.tmp-e.tmp});for(var s=0;s<e.length;s++)r(e[0].tmp,e[s].tmp)>25||t.length&&this.matchResults(e[s],t,!0)||t.push(e[s]);return t},matchResults:function(e,t){for(var r=this.getUsedItems(e),s=0;s<t.length;s++){var a=this.getUsedItems(t[s]);if(!r.filter(function(e){return!a.includes(e)}).length)return!0}return!1},round:function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},calcByFormula:function(e,t){function r(e){return CharacterSkills.getSkill(e).points}if(!Object.values(e).length)return 0;var s=this.preset.skills,a=this.preset.primary,i=Premium.hasBonus("character"),n=Math.pow((0!=e.leadership?e.leadership+r("leadership"):0)*("soldier"==Character.charClass?i?1.5:1.25:1),.5);f=Math.pow(0!=e.pitfall?e.pitfall+r("pitfall"):0,.6),g=Math.pow(0!=e.hide?e.hide+r("hide"):0,.6),p=Math.pow(0!=e.dodge?e.dodge+r("dodge"):0,.5),q=Math.pow(0!=e.aim?e.aim+r("aim"):0,.5),b=(e.fort_damage||0)+(e.fort_damage_sector||0),l="worker"==Character.charClass?i?1.4:1.2:1;var o=0,u=this.preset,c=((e.health||0)+r("health"))*("soldier"==Character.charClass?i?20:15:10)+10*this.preset.level+90;switch(t||a){case"ms":o+=(100+(e.ride||0)+(e.ms||0)+r("ride"))*(1+(e.speed||0)/100);break;case"fort_resistance":o+=this.round(300*("attack"==u.side?e.hide||0:e.pitfall||0)/c+(e.fort_resistance||0),2);break;case"fort_offense":o+=this.round((25+n+q+("attack"==u.side?g:f)+(e.fort_offense||0)+(e.fort_offense_sector||0))*l,2);break;case"fort_defense":o+=this.round((10+n+p+("attack"==u.side?g:f)+(e.fort_defense||0)+(e.fort_defense_sector||0))*l,2);break;case"fort_damage":o+=Math.round((e.left_arm_damage_min||0)+b+((e.left_arm_damage_min||0)+b)*(e.leadership||0)/c);break;case"fort_hp":o+=c||0;break;default:for(var m in s)e[m]&&(o+=s[m]*(e[m]||0))}return o},getValue4Set:function(e,t){var r={};r=this.getSetValue(e,!0);for(var s=e.items,a=0;a<s.length;a++){var i=this.getItemValue(ItemManager.get(s[a]*(t?1e3:1)),!0);for(var n in i)r[n]||(r[n]=0),r[n]+=i[n]}return this.calcByFormula(r)},getSetValue:function(e,t,r){r=r||(this.preset.level?this.preset.level:Character.level);var s=this.preset.skills,a=new west.item.BonusExtractor({level:r}),i={},n=e.getMergedStages();function l(e,t){"damage"!==e&&(i[e]=i[e]||0,i[e]+=t)}function o(e,t){return!!CharacterSkills.allAttrKeys.includes(e)||!t&&!!CharacterSkills.allSkillKeys.includes(e)}for(var u=0;u<n.length;u++){if(affectedSkills=a.getAffectedSkills(n[u]),specialSkills=this.getAdditionalBonus(n[u],0,r),t)for(skill in affectedSkills)l(skill,affectedSkills[skill]);(!t||!o(specialSkills.key)||t&&o(specialSkills.key,!0)&&specialSkills.key in s)&&l(specialSkills.key,specialSkills.value)}return i},getValue4Container:function(e,t,r){var s,a={},i=e.getItems();for(s=0;s<i.length;s++){var n=this.getItemValue(ItemManager.get(i[s]),t,r);for(var l in n)a[l]||(a[l]=0),a[l]+=n[l]}for(var l in n=this.getSetValue4Container(e,t,r))a[l]||(a[l]=0),a[l]+=n[l];return a},getSetValue4Container:function(e,t,r){var s,a={};for(s=0;s<e.sets.length;s++){var i=this.getSetValue(e.sets[s],t,r);for(var n in i)a[n]||(a[n]=0),a[n]+=i[n]}return a},itemsToSets:function(e){for(var t={},r=e.items,s=[],a=0;a<r.length;a++){var i=ItemManager.get(r[a]);if(i.set)if(t[i.set])t[i.set].items.push(i.getId());else{var n=west.storage.ItemSetManager.get(i.set);t[i.set]=new west.item.ItemSet({key:n.key,items:[i.getId()],bonus:n.bonus})}else s.push(i.getId())}for(var l in t)-1===e.sets.findIndex(function(e){return e.key===l})&&e.sets.push(t[l]);return e.items=s,e},getBestItems:function(){this.preset.skills;var e=this.preset.weapon,t=this.preset.primary,r={},s=[],a=Bag.getItemsIdsByBaseItemIds(),i=this;return west.common.forEach(a,function(e,s){var a,n=ItemManager.get(e[0]),l=n.getType(),o=0,u=0;switch(a=i.getItemValue(n,!0),t){case"ms":o=(a.ride||0)+(a.ms||0),u=a.speed||0;break;case"fort_resistance":o=i.calcByFormula(a),u=a.fort_resistance||0;break;case"fort_offense":o=i.calcByFormula(a),u=(a.fort_offense||0)+(a.fort_offense_sector||0);break;case"fort_defense":o=i.calcByFormula(a),u=(a.fort_defense||0)+(a.fort_defense_sector||0);break;default:o=i.calcByFormula(a)}r[l]=r[l]||[],o&&n.wearable()&&r[l].push({item:n,id:n.getId(),base_id:s,primary:o,main:u})}),west.common.forEach(r,function(a,n){var l=Wear.get(n);if(l){l=ItemManager.get(l.getId()),spec_wear={};var o=0,u=0;switch(spec_wear=i.getItemValue(l,!0),t){case"ms":o=(spec_wear.ride||0)+(spec_wear.ms||0),u=spec_wear.speed||0;break;case"fort_resistance":o=i.calcByFormula(spec_wear),u=spec_wear.fort_resistance||0;break;case"fort_offense":o=i.calcByFormula(spec_wear),u=(spec_wear.fort_offense||0)+(spec_wear.fort_offense_sector||0);break;case"fort_defense":o=i.calcByFormula(spec_wear),u=(spec_wear.fort_defense||0)+(spec_wear.fort_defense_sector||0);break;default:o=i.calcByFormula(spec_wear)}a.push({item:l,id:l.getId(),base_id:l.getItemBaseId(),primary:o,main:u})}if(r[n]=a.sort(function(e,t){return e.primary||e.main?t.primary||t.main?t.main-e.main||t.primary-e.primary:-1:1}),r[n].length){var c=r[n][0];if("right_arm"===n&&"none"!==e){var f=r[n].filter(function(t){return t.primary===c.primary&&t.item.sub_type===e});s.push(f.length?f[0].item:c.item)}else s.push(c.item)}}),s},beatsBestItems:function(e,t){var r,s,a=e.getUsedSlots(),i={};for(s=0;s<t.length;s++)if(-1!==a.indexOf(t[s].getType())){var n=this.getItemValue(t[s],!0);for(var l in n)i[l]||(i[l]=0),i[l]+=n[l]}return r=this.calcByFormula(i),this.getValue4Set(e)>r},itemsCombineable:function(e){var t,r,s={};for(t=0;t<e.length;t++){if(!0===s[r=ItemManager.get(e[t]).type])return!1;s[r]=!0}return!0},createCombinations:function(e,t){var r,s,a,i,n;if(t>e.length||t<=0)return[];if(t==e.length)return[e];if(1==t){for(a=[],r=0;r<e.length;r++)a.push([e[r]]);return a}for(a=[],r=0;r<e.length-t+1;r++)for(i=e.slice(r,r+1),n=this.createCombinations(e.slice(r+1),t-1),s=0;s<n.length;s++)a.push(i.concat(n[s]));return a},sortSetItems:function(e){var t=ItemManager.get,r=this;e.items.sort(function(e,s){return r.calcByFormula(r.getItemValue(t(s),!0))-r.calcByFormula(r.getItemValue(t(e),!0))})},filterWeapons:function(e){for(var t,r=[],s=0;s<e.length;s++){var a=ItemManager.get(e[s]);"right_arm"===a.type&&r.push(e[s]),"right_arm"===a.type&&a.sub_type!==this.preset.weapon&&"none"!==this.preset.weapon&&(t=e[s])}return!r.length||r.length<2?e:e.filter(function(e){return e!==t})},createSubsets:function(e,t,r){this.preset.skills;var s,a,i,n,l,o,u,c=this.preset.primary,f=[];for(s=0;s<e.length;s++)for(a=e[s],r&&!c&&this.sortSetItems(a),i=a.items.length;i>0;i--)if(a.bonus.hasOwnProperty(i)){var m=this.filterWeapons(a.items);for(l=0,o=(n=r&&!c?[a.items.slice(0,i)]:this.createCombinations(m,i)).length;l<o;l++)this.itemsCombineable(n[l])&&(u=new west.item.ItemSet({key:a.key,items:n[l],bonus:a.bonus}),this.beatsBestItems(u,t)&&f.push(u))}return f},filterUneffectiveSets:function(e){var t,r,s,a=[],i={},n={};for(t=0;t<e.length;t++)n=this.getSetValue(e[t],!0),this.calcByFormula(n)<1||(i[r=JSON.stringify(e[t].getUsedSlots().sort())]?(s=this.getValue4Set(e[t]),this.getValue4Set(i[r])<s&&(i[r]=e[t])):i[r]=e[t]);for(t in i)a.push(i[t]);return a}},TWIR_calc.preset=TWIR_calc.getPreset();
