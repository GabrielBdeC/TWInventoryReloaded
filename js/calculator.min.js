TWIR_calc={_memo:{},init:function(){this.preset=this.getPreset()},getPreset:function(){return{skills:{},sort:void 0,weapon:"none",side:"attack",level:Character.level,wearable:!0,new_formula:!1,reset:function(){Object.assign(this,TWIR.calc.getPreset())}}},getAnimalSpeedValue:function(e){return Math.round(Character.defaultSpeed/(Character.defaultSpeed*e)*100-100)},calcSpeed:function(e){var t=this,s=$.extend({},this.preset);this.preset.skills="ms",TWIR.calc.calcBest(function(r){e(t.getUsedItems(r[0])),t.preset=s})},calcBest:function(e){var t=this;this.getBestSet(function(s){t.fullResult=s,t.result=t.reduceResults(s),t.preset.sort&&t.sortResult(t.preset.sort),e(t.result)})},sortResult:function(e){this.result.sort(function(t,s){return s.stats[e]-t.stats[e]||s.tmp-t.tmp})},getUsedItems:function(e,t){if("object"!=typeof e)return new Array;for(var s=e.items.slice(0),r=0,a=e.sets.length;r<a;r++)s.push.apply(s,e.sets[r].getItems());for(var i,n,l=[],o=(r=0,s.length);r<o;r++)(i=Bag.getItemByItemId(s[r]))?!(n=Wear.get(i.getType()))||n&&(n.getItemBaseId()!==i.getItemBaseId()||n.getItemLevel()<i.getItemLevel())?l.push(t?i.getItemBaseId():i.getId()):l.push(t?n.getItemBaseId():n.getId()):l.push(t?parseInt(s[r]/1e3):s[r]);return l},getAvailableItems:function(e,t){for(var s,r,a=e.getItems(),i=[],n=[],l=0,o=a.length;l<o;l++)if((s=Bag.getItemsIdsByBaseItemId(a[l])).length)for(var u=0,h=(r=Bag.getItemsByItemIds(s)).length;u<h;u++)(t||this.wearable(r[u].obj))&&(0===u&&i.push(r[u].getId()),n.push(r[u].getId()));else Wear.carries(a[l])&&(i.push(Wear.getByBaseId(a[l]).getId()),n.push(Wear.getByBaseId(a[l]).getId()));return[i,n]},filterUnavailableSets:function(e,t){for(var s=[],r=0,a=e.length;r<a;r++){var i=e[r],n=this.getAvailableItems(i,t)[0];n.length&&s.push(new west.item.ItemSet({key:i.key,items:n,bonus:i.bonus}))}return s},getBestSet:function(e){var t=this,s=this.preset.skills,r=["fort_offense","fort_defense","fort_damage","fort_resistance","fort_hp"];if("object"==typeof s&&$.isEmptyObject(s))return e(new Array);var a,i,n,l,o,u=0;o=this.filterUnavailableSets(west.storage.ItemSetManager.getAll()),a=this.getBestItems(),i=new west.item.ItemSetContainer;for(var h=0,c=a.length;h<c;h++)i.addItem(a[h].getId());for((n=this.createSubsets(o,a)).length>500&&"object"==typeof s&&(n=this.createSubsets(o,a,!0),console.log("using approximation...")),n=this.filterUneffectiveSets(n),(n=west.item.Calculator.fillEmptySlots(west.item.Calculator.combineSets(n),a)).push(i),h=0,c=n.length;h<c;h++){n[h]=this.itemsToSets(n[h]);var m=this.getValue4Container(n[h],!0);l=this.calcByFormula(m),n[h].tmp=l,l>u&&(u=l,n[h]),"string"==typeof s&&r.includes(s)&&(n[h].stats={},$.each(r,function(e,s){n[h].stats[s]=t.calcByFormula(m,s)}))}return e(n),n},makeEmUp:function(e,t){for(var s=[],r=0,a=e.length;r<a;r++)if(t)s.push(1e3*e[r]);else for(var i=0;i<=Game.ui.itemUpgrade.max_level;i++)s.push(1e3*e[r]+i);return s},getBestOwnItems:function(e){var t=Bag.getItemsByItemIds(this.makeEmUp(e)),s=[];for(var r in Wear.wear)e.includes(Wear.wear[r].getItemBaseId())&&t.push(Wear.wear[r]);for(var a={},i=0,n=t.length;i<n;i++){var l=t[i].getType();a[l]?a[l]&&t[i].getItemLevel()>a[l].getItemLevel()&&(a[l]=t[i]):a[l]=t[i]}for(var o in a)s.push(a[o].getId());return s},countObjectKeys:function(e){var t=0;return Object&&Object.keys?t=Object.keys(e).length:jpreset.each(e,function(){t++}),t},wearable:function(e){if(!0===this.preset.wearable){if(e.characterSex&&(e.characterSex!==Character.charSex||"greenhorn"===Character.charClass))return!1;if(e.characterClass&&e.characterClass!==Character.charClass)return!1;if(e.duelLevel&&e.duelLevel>Character.duelLevel)return!1}var t=Character.itemLevelRequirementDecrease,s=t.all+(t[e.type]||0);return!(e.level&&e.level-s>this.preset.level)},isBaseId:function(e){for(var t=e.toString().substr(-3),s=0;s<=5;s++){var r=("000"+(s||0).toString()).slice(-3);if(t.match(r))return!1}return!0},bonus4Items:function(e,t){for(var s=s={items:e,sets:[]},r=this.itemsToSets(s),a=new west.item.ItemSetContainer,i=0,n=r.items.length;i<n;i++)a.addItem(r.items[i]);for(var l=0,o=r.sets.length;l<o;l++)a.addSet(r.sets[l]);return this.getValue4Container(a,!1,t)},bonusFromItems:function(e,t){for(var s={},r=0,a=e.length;r<a;r++){var i=this.getItemValue(ItemManager.get(e[r]*(this.isBaseId(e[r])?1e3:1)),!1,t);for(var n in i)s[n]||(s[n]=0),s[n]+=i[n]}return s},bonusFromSet:function(e,t){var s=west.storage.ItemSetManager.get(e.key),r=new west.item.ItemSet({key:e.key,items:e.items,bonus:s.bonus});return this.getSetValue(r,!1,t)},fullBonusFromSet:function(e,t){for(var s=west.storage.ItemSetManager.get(e.key),r=new west.item.ItemSet({key:e.key,items:e.items,bonus:s.bonus}),a=this.getSetValue(r,!1,t),i=e.items,n=0,l=i.length;n<l;n++){var o=this.getItemValue(ItemManager.get(i[n]*(this.isBaseId(i[n])?1e3:1)),!1,t);for(var u in o)a[u]||(a[u]=0),a[u]+=o[u]}return a},mergeBonus:function(e){var t=["experience","dollar","drop","luck"],s={skill:{},attribute:{},fortbattle:{},job:{},income:{},damage:{},other:{}};for(var r in e)switch(!0){case-1!==r.indexOf("job_"):s.job[r.replace(/\D/g,"")]=e[r];break;case"job"===r:s.job[r]=e[r];break;case-1!==r.indexOf("fort_"):s.fortbattle[r]=e[r];break;case CharacterSkills.allSkillKeys.includes(r):s.skill[r]=e[r];break;case CharacterSkills.allAttrKeys.includes(r):s.attribute[r]=e[r];break;case t.includes(r):s.income[r]=e[r];break;case-1!==r.indexOf("damage_min")||-1!==r.indexOf("damage_max"):s.damage[r]=e[r];break;default:s.other[r]=e[r]}return s},getAdditionalBonus:function(e,t,s){s=s||(this.preset.level?this.preset.level:Character.level);var r=new west.item.BonusExtractor({level:s},t);switch("character"===e.type?(value=r.getCharacterItemValue(e),(e=e.bonus).type in r.keyDescMapping&&(value=Math.round(100*value))):e.type in r.keyDescMapping?(value=r.getValue(e),value=Math.round(100*value)):value=r.getValue(e),e.type){case"skill":case"attribute":key=e.name;break;case"fortbattle":key="fort_"+e.name+(e.isSector?"_sector":"");break;case"job":key=e.type+(e.job&&"all"===e.job?"":"_"+e.job);break;default:key=e.type}return{key:key,value:value}},getItemValue:function(e,t,s){s=s||(this.preset.level?this.preset.level:Character.level);var r,a,i=this.preset.skills,n=new west.item.BonusExtractor({level:s},e.getItemLevel()),l={},o=[],u=e.short+"_"+e.getItemLevel()+"_"+s+"_"+JSON.stringify(this.preset)+"_"+t;if(this._memo[u])return this._memo[u];function h(e,t){"damage"!==e&&(l[e]=l[e]||0,l[e]+=t)}function c(e,t){return!!CharacterSkills.allAttrKeys.includes(e)||!t&&!!CharacterSkills.allSkillKeys.includes(e)}if(e.speed&&h("ms",Math.round(1/e.speed*100-100)),e instanceof west.item.Weapon&&(h(e.type+"_damage_min",e.getDamage({level:s}).min),h(e.type+"_damage_max",e.getDamage({level:s}).max)),"object"==typeof e.bonus.attributes&&this.countObjectKeys(e.bonus.attributes)>0)for(var m in e.bonus.attributes)if(t&&e.bonus.attributes[m]){"object"==typeof i&&m in i&&h(m,e.bonus.attributes[m]),o=CharacterSkills.getSkillKeys4Attribute(m);for(var f=0;f<o.length;f++)h(o[f],e.bonus.attributes[m])}else!t&&e.bonus.attributes[m]&&h(m,e.bonus.attributes[m]);if("object"==typeof e.bonus.skills&&this.countObjectKeys(e.bonus.skills)>0)for(var m in e.bonus.skills)e.bonus.skills[m]&&h(m,e.bonus.skills[m]);if(e.bonus.item.length)for(m=0,len=e.bonus.item.length;m<len;m++){if(r=n.getAffectedSkills(e.bonus.item[m]),a=this.getAdditionalBonus(e.bonus.item[m],e.getItemLevel(),s),t)for(skill in r)h(skill,r[skill]);(!t||!c(a.key)||t&&c(a.key,!0)&&"object"==typeof i&&a.key in i)&&h(a.key,a.value)}return(e.usebonus||e.action||JobList.dropsItem(e.item_id))&&(l={}),this._memo[u]=l,l},reduceResults:function(e){if(!$.isArray(e)||!e.length)return new Array;var t=[];function s(e,t){return e-t==0?0:100*Math.abs((e-t)/t)}e.sort(function(e,t){return t.tmp-e.tmp});for(var r=0,a=e.length;r<a;r++)s(e[0].tmp,e[r].tmp)>25||t.length&&this.matchResults(e[r],t,!0)||t.push(e[r]);return t},matchResults:function(e,t){for(var s=this.getUsedItems(e),r=0;r<t.length;r++){var a=this.getUsedItems(t[r]);if(!s.filter(function(e){return!a.includes(e)}).length)return!0}return!1},round:function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},mean:function(e){for(var t=0,s=0,r=arguments.length;s<r;s++)t+=arguments[s];return t/arguments.length},median:function(e){var t=arguments.length;return e=[].slice.call(arguments).sort(),t%2==0?(e[t/2-1]+e[t/2])/2:e[(t-1)/2]},calcByFormula:function(e,t){var s=0,r=this.preset,a=this.preset.skills;function i(e){return CharacterSkills.getSkill(e).points}var n=Premium.hasBonus("character"),l=Math.pow((e.leadership||0)+i("leadership")*("soldier"==Character.charClass?n?1.5:1.25:1),.5),o="worker"==Character.charClass?n?1.4:1.2:1,u="worker"==Character.charClass?n?10:5:0,h=(e.fort_damage||0)+(e.fort_damage_sector||0),c=((e.health||0)+i("health"))*("soldier"==Character.charClass?n?20:15:10)+10*this.preset.level+90,m=this.mean(e.left_arm_damage_min||0,e.left_arm_damage_max||0)+h,f="attack"==r.side?(e.hide||0)+i("hide"):(e.pitfall||0)+i("pitfall"),g=(e.leadership||0)+i("leadership"),p=(e.aim||0)+i("aim"),d=(e.dodge||0)+i("dodge");switch(t||("string"==typeof a?a:void 0)){case"ms":s+=(100+(e.ride||0)+(e.ms||0)+i("ride"))*(1+(e.speed||0)/100),e.ride||e.speed||(s=0);break;case"fort_resistance":1==this.preset.new_formula?s+=this.round(1+Math.max(0,(Math.pow(Math.min(f,g,d),.8)+Math.pow(this.median(f,g,d),.7)+Math.pow(Math.max(f,g,d),.6)-Math.pow(Math.abs(c/10-this.mean(f,g,d)),.6))/3)+(e.fort_resistance||0),2):s+=this.round(300*f/c+(e.fort_resistance||0),2);break;case"fort_offense":s+=this.round((25+l+Math.pow(p,.5)+Math.pow(f,.6)+(e.fort_offense||0)+(e.fort_offense_sector||0))*o,2);break;case"fort_defense":s+=this.round((10+l+Math.pow(d,.5)+Math.pow(f,.6)+(e.fort_defense||0)+(e.fort_defense_sector||0))*o,2);break;case"fort_damage":1==this.preset.new_formula?s+=Math.round(((e.left_arm_damage_min||0)+h)*(1+Math.max(0,(Math.pow(Math.min(f,g,p),.8)+Math.pow(this.median(f,g,p),.7)+Math.pow(Math.max(f,g,p),.6)-Math.pow(Math.abs(c/10-this.mean(f,g,p)),.6))/400))):s+=Math.round(m+m*g/c);break;case"fort_hp":s+=c||0;break;case"construct":s+=Math.floor((3*((e.build||0)+i("build"))+(e.repair||0)+i("repair")+(e.leadership||0)+i("leadership"))/100*(100+u))+(e.job||0);break;default:if("object"==typeof a)for(var f in a)e[f]&&(s+=a[f]*(e[f]||0))}return t||"string"!=typeof a||(s-=this.calcByFormula({},a)),(isNaN(s)||s<1)&&(s=0),s},getValue4Set:function(e,t){var s={};s=this.getSetValue(e,!0);for(var r=e.items,a=0,i=r.length;a<i;a++){var n=this.getItemValue(ItemManager.get(r[a]*(this.isBaseId(r[a])?1e3:1)),!0);for(var l in n)s[l]||(s[l]=0),s[l]+=n[l]}return t?s:this.calcByFormula(s)},getSetValue:function(e,t,s){s=s||(this.preset.level?this.preset.level:Character.level);var r=this.preset.skills,a=new west.item.BonusExtractor({level:s}),i={},n=e.getMergedStages();function l(e,t){"damage"!==e&&(i[e]=i[e]||0,i[e]+=t)}function o(e,t){return!!CharacterSkills.allAttrKeys.includes(e)||!t&&!!CharacterSkills.allSkillKeys.includes(e)}for(var u=0,h=n.length;u<h;u++){if(affectedSkills=a.getAffectedSkills(n[u]),specialSkills=this.getAdditionalBonus(n[u],0,s),t)for(skill in affectedSkills)l(skill,affectedSkills[skill]);(!t||!o(specialSkills.key)||t&&o(specialSkills.key,!0)&&"object"==typeof r&&specialSkills.key in r)&&l(specialSkills.key,specialSkills.value)}return i},getValue4Container:function(e,t,s){for(var r={},a=e.getItems(),i=0,n=a.length;i<n;i++){var l=this.getItemValue(ItemManager.get(a[i]),t,s);for(var o in l)r[o]||(r[o]=0),r[o]+=l[o]}for(var o in l=this.getSetValue4Container(e,t,s))r[o]||(r[o]=0),r[o]+=l[o];return r},getSetValue4Container:function(e,t,s){for(var r={},a=0,i=e.sets.length;a<i;a++){var n=this.getSetValue(e.sets[a],t,s);for(var l in n)r[l]||(r[l]=0),r[l]+=n[l]}return r},itemsToSets:function(e){for(var t={},s=e.items,r=[],a=0,i=s.length;a<i;a++){var n=ItemManager.get(s[a]);if(n.set)if(t[n.set])t[n.set].items.push(n.getId());else{var l=west.storage.ItemSetManager.get(n.set);t[n.set]=new west.item.ItemSet({key:l.key,items:[n.getId()],bonus:l.bonus})}else r.push(n.getId())}for(var o in t)-1===e.sets.findIndex(function(e){return e.key===o})&&e.sets.push(t[o]);return e.items=r,e},filterBoni:function(e,t){var s=this.preset.skills,r={};switch("string"==typeof s?s:void 0){case"ms":r.tmp=(e.ride||0)+(e.ms||0),r.val=e.speed||0;break;case"fort_resistance":r.tmp=this.calcByFormula(e),r.val=e.fort_resistance||0;break;case"fort_offense":r.tmp=this.calcByFormula(e),r.val=(e.fort_offense||0)+(e.fort_offense_sector||0),t&&(r.val=0);break;case"fort_defense":r.tmp=this.calcByFormula(e),r.val=(e.fort_defense||0)+(e.fort_defense_sector||0),t&&(r.val=0);break;default:r.tmp=this.calcByFormula(e),r.val=0}return r},getBestItems:function(){var e=this,t=(this.preset.skills,{}),s=[],r=Bag.getItemsIdsByBaseItemIds();for(var a in r){var i=(u=ItemManager.get(r[a][0])).getType(),n=this.getItemValue(u,!0),l=this.filterBoni(n);t[i]=t[i]||[],"right_arm"===i&&"none"!==this.preset.weapon&&u.sub_type!==this.preset.weapon||(l.tmp||l.val)&&this.wearable(u)&&t[i].push({item:u,id:u.getId(),base_id:u.getItemBaseId(),tmp:l.tmp,val:l.val})}for(var o in t){var u,h=t[o];(u=Wear.get(o))&&(u=ItemManager.get(u.getId()),n=this.getItemValue(u,!0),l=this.filterBoni(n),"right_arm"===o&&"none"!==this.preset.weapon&&u.sub_type!==this.preset.weapon||h.push({item:u,id:u.getId(),base_id:u.getItemBaseId(),tmp:l.tmp,val:l.val})),t[o]=h.sort(function(t,s){return t.tmp||t.val?s.tmp||s.val?"animal"===o&&"ms"===e.preset.skills?s.tmp-t.tmp||s.val-t.val:s.val-t.val||s.tmp-t.tmp:-1:1}),t[o].length&&s.push(t[o][0].item)}return s},beatsBestItems:function(e,t){for(var s,r=e.getUsedSlots(),a={},i=0,n=t.length;i<n;i++)if(-1!==r.indexOf(t[i].getType())){var l=this.getItemValue(t[i],!0);for(var o in l)a[o]||(a[o]=0),a[o]+=l[o]}return s=this.calcByFormula(a),this.getValue4Set(e)>s},itemsCombineable:function(e){for(var t,s={},r=0,a=e.length;r<a;r++){if(!0===s[t=ItemManager.get(e[r]).type])return!1;s[t]=!0}return!0},createCombinations:function(e,t){var s,r,a;if(t>e.length||t<=0)return[];if(t==e.length)return[e];if(1==t){s=[];for(var i=0,n=e.length;i<n;i++)s.push([e[i]]);return s}for(s=[],i=0,n=e.length;i<n-t+1;i++){r=e.slice(i,i+1);for(var l=0,o=(a=this.createCombinations(e.slice(i+1),t-1)).length;l<o;l++)s.push(r.concat(a[l]))}return s},sortSetItems:function(e){var t=ItemManager.get,s=this;e.items.sort(function(e,r){return s.calcByFormula(s.getItemValue(t(r),!0))-s.calcByFormula(s.getItemValue(t(e),!0))})},filterWeapons:function(e){if("none"===this.preset.weapon)return e;for(var t,s=[],r=0,a=e.length;r<a;r++){var i=ItemManager.get(e[r]);"right_arm"===i.type&&s.push(e[r]),"right_arm"===i.type&&i.sub_type!==this.preset.weapon&&(t=e[r])}return!s.length||s.length<2?e:e.filter(function(e){return e!==t})},createSubsets:function(e,t,s){for(var r,a,i,n=this.preset.skills,l=[],o=0,u=e.length;o<u;o++){r=e[o],s&&"object"==typeof n&&this.sortSetItems(r);for(var h=r.items.length;h>0;h--)if(r.bonus.hasOwnProperty(h))for(var c=this.filterWeapons(r.items),m=0,f=(a=s&&"object"==typeof n?[r.items.slice(0,h)]:this.createCombinations(c,h)).length;m<f;m++)this.itemsCombineable(a[m])&&(i=new west.item.ItemSet({key:r.key,items:a[m],bonus:r.bonus}),this.beatsBestItems(i,t)&&l.push(i))}return l},filterUneffectiveSets:function(e){for(var t,s,r,a=[],i={},n=0,l=e.length;n<l;n++)setValue=this.getSetValue(e[n],!0),setValue=this.filterBoni(setValue,!0),setValue.tmp<1&&setValue.val<1||(t=JSON.stringify(e[n].getUsedSlots().sort()),s=this.getValue4Set(e[n],!0),((r=this.filterBoni(s,!0)).tmp||r.val)&&(i[t]=i[t]||[],i[t].push({set:e[n],tmp:r.tmp,val:r.val})));for(var o in i)i[o]=i[o].sort(function(e,t){return e.tmp||e.val?t.tmp||t.val?t.val-e.val||t.tmp-e.tmp:-1:1}),i[o].length&&a.push(i[o][0].set);return a}},TWIR_calc.init();
