!function(e){TWIR_calc={_memo:{},getQuery:function(){return{skills:{},primary:void 0,secondary:void 0,mode:"exact",weapon:"shot",side:"attack",level:Character.level,reset:function(){Object.assign(this,TWIR_calc.getQuery())}}},calcBest:function(e){var t=this.getBestSet();return e(t),t},getUsedItems:function(e,t){var r=e.items.slice(0);for(n=0;n<e.sets.length;n++)r.push.apply(r,e.sets[n].getItems());for(var a,s,i=[],n=0;n<r.length;n++)(a=Bag.getItemByItemId(r[n]))?!(s=Wear.get(a.getType()))||s&&(s.getItemBaseId()!==a.getItemBaseId()||s.getItemLevel()<a.getItemLevel())?i.push(t?a.getItemBaseId():a.getId()):i.push(t?s.getItemBaseId():s.getId()):i.push(t?parseInt(r[n]/1e3):r[n]);return i},getBestSet:function(){var t,r,a,s,i,n,l=this,o=0;for(n=west.item.Calculator.filterUnavailableSets(west.storage.ItemSetManager.getAll()),t=this.getBestItems(),r=new west.item.ItemSetContainer,s=0;s<t.length;s++)r.addItem(t[s].getId());for(a=this.createSubsets(n,t),e.__limitclothcalc&&a.length>500&&(a=this.createSubsets(n,t,!0),console&&console.log("using approximation...")),a=this.filterUneffectiveSets(a),(a=west.item.Calculator.fillEmptySlots(west.item.Calculator.combineSets(a),t)).push(r),s=0;s<a.length;s++){a[s]=this.itemsToSets(a[s]);var u=this.getValue4Container(a[s],!0);i=this.calcByFormula(u),a[s].tmp=i,a[s].stats={},$.each(l.getSelection(l.query.primary),function(e,t){a[s].stats[t]=l.calcByFormula(u,t)}),i>o&&(o=i,a[s])}var c=this.reduceResults(a);return this.result=a,c},getBestOwnItems:function(e){var t=Bag.getItemsByItemIds(TWIR.makeEmUp(e)),r=[];for(var a in Wear.wear)e.includes(Wear.wear[a].getItemBaseId())&&t.push(Wear.wear[a]);for(var s={},i=0;i<t.length;i++){var n=t[i].getType();s[n]?s[n]&&t[i].getItemLevel()>s[n].getItemLevel()&&(s[n]=t[i]):s[n]=t[i]}for(var l in s)r.push(s[l].getId());return r},countObjectKeys:function(e){var t=0;return Object&&Object.keys?t=Object.keys(e).length:jQuery.each(e,function(){t++}),t},exportFullBonus:function(e,t,r,a){if(!$.isEmptyObject(e)){var s={};if(t)s=this.getValue4Container(e,!1,a);else{var i=west.storage.ItemSetManager.get(e.key);s=this.getSetValue(i,!1,a);for(var n=e.items,l=0;l<n.length;l++){var o=this.getItemValue(ItemManager.get(n[l]*(r?1e3:1)),!1,a);for(var u in o)s[u]||(s[u]=0),s[u]+=o[u]}}return this.mergeBonus(s)}},mergeBonus:function(e){var t=["experience","dollar","drop","luck"],r={skill:{},attribute:{},fortbattle:{},job:{},income:{},other:{}};for(var a in e)switch(!0){case-1!==a.indexOf("job_"):r.job[a.replace(/\D/g,"")]=e[a];break;case"job"===a:r.job[a]=e[a];break;case-1!==a.indexOf("fort_"):r.fortbattle[a]=e[a];break;case CharacterSkills.allSkillKeys.includes(a):r.skill[a]=e[a];break;case CharacterSkills.allAttrKeys.includes(a):r.attribute[a]=e[a];break;case t.includes(a):r.income[a]=e[a];break;default:r.other[a]=e[a]}return r},getAdditionalBonus:function(e,t,r){var a=new west.item.BonusExtractor({level:r||this.query.level},t);switch("character"===e.type?(value=a.getCharacterItemValue(e),(e=e.bonus).type in a.keyDescMapping&&(value=Math.round(100*value))):e.type in a.keyDescMapping?(value=a.getValue(e),value=Math.round(100*value)):value=a.getValue(e),e.type){case"skill":case"attribute":key=e.name;break;case"fortbattle":key="fort_"+e.name+(e.isSector?"_sector":"");break;case"job":key=e.type+(e.job&&"all"===e.job?"":"_"+e.job);break;default:key=e.type}return{key:key,value:value}},getItemValue:function(e,t,r){var a,s,i,n=new west.item.BonusExtractor({level:r||this.query.level},e.getItemLevel()),l={},o=[],u=e.short+"_"+e.getItemLevel()+"_"+JSON.stringify(this.query);if(this._memo[u])return this._memo[u];function c(e,t){"damage"!==e&&(l[e]=l[e]||0,l[e]+=t)}if(e.speed&&c("ms",Math.round(1/e.speed*100-100)),e instanceof west.item.Weapon&&(c(e.type+"_damage_min",e.getDamage({level:r||this.query.level}).min),c(e.type+"_damage_max",e.getDamage({level:r||this.query.level}).max)),"object"==typeof e.bonus.attributes&&this.countObjectKeys(e.bonus.attributes)>0)for(var f in e.bonus.attributes)if(t&&e.bonus.attributes[f]){o=CharacterSkills.getSkillKeys4Attribute(f);for(var h=0;h<o.length;h++)c([o[h]],e.bonus.attributes[f])}else e.bonus.attributes[f]&&c(f,e.bonus.attributes[f]);if("object"==typeof e.bonus.skills&&this.countObjectKeys(e.bonus.skills)>0)for(var f in e.bonus.skills)e.bonus.skills[f]&&c(f,e.bonus.skills[f]);if(e.bonus.item.length)for(f=0;f<e.bonus.item.length;f++){if(a=n.getAffectedSkills(e.bonus.item[f]),s=this.getAdditionalBonus(e.bonus.item[f],e.getItemLevel(),r),t)for(skill in a)c(skill,a[skill]);t&&(i=s.key,CharacterSkills.allAttrKeys.includes(i)||CharacterSkills.allSkillKeys.includes(i))||c(s.key,s.value)}return(e.usebonus||e.action)&&(l={}),this._memo[u]=l,l},getSelection:function(e){var t=["fort_offense","fort_defense","fort_damage","fort_resistance","hp"],r=[];switch(t.indexOf(e)){case 0:r=[1,2,3,4];break;case 1:r=[0,2,3,4];break;case 2:r=[0,1,3];break;case 3:r=[0,1,2];break;case 4:r=[0,1,3]}return t.filter(function(e,t){return r.includes(t)})},reduceResults:function(e){var t=[];function r(e,t){return 100*Math.abs((e-t)/((e+t)/2))}e.sort(function(e,t){return t.tmp-e.tmp});for(var a=0;a<e.length;a++)r(e[0].tmp,e[a].tmp)>25||t.length&&this.getDuplicate(e[a],t,!0)||t.push(e[a]);return t},getDuplicate:function(e,t,r){for(var a=this.getUsedItems(e),s=0;s<t.length;s++){var i=this.getUsedItems(t[s]),n=a.filter(function(e){return!i.includes(e)});if(r&&!n.length)return!0;if(!r&&n.length)return n}return!1},reviewResults:function(e){var t=e;return $.each(this.getSelection(this.query.primary),function(e,r){!function(e){t.sort(function(t,r){return r.stats[e]-t.stats[e]});for(var r=0;r<t.length;r++)t[r].r||(t[r].r=[]),t[r].r.push(r)}(r)}),t.sort(function(e,t){return t.tmp-e.tmp}),t},getBalResult:function(e){var t=[];for(var r=0;r<e.length;r++)t.push(e[r]),t[r].r=t[r].r.reduce(function(e,t){return e+t},0);return t.sort(function(e,t){return e.r-t.r||t.tmp-e.tmp}),t},round:function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},calcByFormula:function(e,t){function r(e){return CharacterSkills.getSkill(e).points}if(!Object.values(e).length)return 0;var a=this.query.skills,s=this.query.primary,i=(this.query.secondary,Premium.hasBonus("character")),n=Math.pow((0!=e.leadership?e.leadership+r("leadership"):0)*("soldier"==Character.charClass?i?1.5:1.25:1),.5);f=Math.pow(0!=e.pitfall?e.pitfall+r("pitfall"):0,.6),g=Math.pow(0!=e.hide?e.hide+r("hide"):0,.6),p=Math.pow(0!=e.dodge?e.dodge+r("dodge"):0,.5),q=Math.pow(0!=e.aim?e.aim+r("aim"):0,.5),b=(e.fort_damage||0)+(e.fort_damage_sector||0),l="worker"==Character.charClass?i?1.4:1.2:1;var o=0,u=this.query,c=((e.health||0)+r("health"))*("soldier"==Character.charClass?i?20:15:10)+10*this.query.level+90;switch(t||s){case"ms":o+=(100+(e.ride||0)+(e.ms||0)+r("ride"))*(1+(e.speed||0)/100);break;case"fort_resistance":o+=this.round(300*("attack"==u.side?e.hide||0:e.pitfall||0)/c+(e.fort_resistance||0),2);break;case"fort_offense":o+=this.round((25+n+q+("attack"==u.side?g:f)+(e.fort_offense||0)+(e.fort_offense_sector||0))*l,2);break;case"fort_defense":o+=this.round((10+n+p+("attack"==u.side?g:f)+(e.fort_defense||0)+(e.fort_defense_sector||0))*l,2);break;case"fort_damage":o+=Math.round((e.left_arm_damage_min||0)+b+((e.left_arm_damage_min||0)+b)*(e.leadership||0)/c);break;case"hp":o+=e.health||0;break;default:for(var h in a)e[h]&&(o+=a[h]*(e[h]||0))}return o},getValue4Set:function(e,t){var r={};r=this.getSetValue(e,!0);for(var a=e.items,s=0;s<a.length;s++){var i=this.getItemValue(ItemManager.get(a[s]*(t?1e3:1)),!0);for(var n in i)r[n]||(r[n]=0),r[n]+=i[n]}return this.calcByFormula(r)},getSetValue:function(e,t,r){var a,s=new west.item.BonusExtractor({level:r||this.query.level}),i={},n=e.getMergedStages();function l(e,t){"damage"!==e&&(i[e]=i[e]||0,i[e]+=t)}for(var o=0;o<n.length;o++){if(affectedSkills=s.getAffectedSkills(n[o]),specialSkills=this.getAdditionalBonus(n[o],0,r),t)for(skill in affectedSkills)l(skill,affectedSkills[skill]);t&&(a=specialSkills.key,CharacterSkills.allAttrKeys.includes(a)||CharacterSkills.allSkillKeys.includes(a))||l(specialSkills.key,specialSkills.value)}return i},getValue4Container:function(e,t,r){var a,s={},i=e.getItems();for(a=0;a<i.length;a++){var n=this.getItemValue(ItemManager.get(i[a]),t,r);for(var l in n)s[l]||(s[l]=0),s[l]+=n[l]}for(var l in n=this.getSetValue4Container(e,t,r))s[l]||(s[l]=0),s[l]+=n[l];return s},getSetValue4Container:function(e,t,r){var a,s={};for(a=0;a<e.sets.length;a++){var i=this.getSetValue(e.sets[a],t,r);for(var n in i)s[n]||(s[n]=0),s[n]+=i[n]}return s},itemsToSets:function(e){for(var t={},r=e.items,a=[],s=0;s<r.length;s++){var i=ItemManager.get(r[s]);if(i.set)if(t[i.set])t[i.set].items.push(i.getId());else{var n=west.storage.ItemSetManager.get(i.set);t[i.set]=new west.item.ItemSet({key:n.key,items:[i.getId()],bonus:n.bonus})}else a.push(i.getId())}for(var l in t)-1===e.sets.findIndex(function(e){return e.key===l})&&e.sets.push(t[l]);return e.items=a,e},getBestItems:function(){this.query.skills;var e=this.query.primary,t=this.query.weapon,r={},a=[],s=0,i=0,n=Bag.getItemsIdsByBaseItemIds(),l=this;west.common.forEach(n,function(t,a){var n,o=ItemManager.get(t[0]),u=o.getType();switch(n=l.getItemValue(o,!0),e){case"ms":s=(n.ride||0)+(n.ms||0),i=n.speed||0;break;case"fort_resistance":s=l.calcByFormula(n),i=n.fort_resistance||0;break;case"fort_offense":s=l.calcByFormula(n),i=(n.fort_offense||0)+(n.fort_offense_sector||0);break;case"fort_defense":s=l.calcByFormula(n),i=(n.fort_defense||0)+(n.fort_defense_sector||0);break;default:s=l.calcByFormula(n)}r[u]=r[u]||[],s&&o.wearable()&&r[u].push({item:o,id:o.getId(),base_id:a,value:s,special:i})});var o=0,u=0;return west.common.forEach(r,function(s,i){var n=Wear.get(i);if(n){switch(n=ItemManager.get(n.getId()),spec_wear={},spec_wear=l.getItemValue(n,!0),e){case"ms":o=(spec_wear.ride||0)+(spec_wear.ms||0),u=spec_wear.speed||0;break;case"fort_resistance":o=l.calcByFormula(spec_wear),u=spec_wear.fort_resistance||0;break;case"fort_offense":o=l.calcByFormula(spec_wear),u=(spec_wear.fort_offense||0)+(spec_wear.fort_offense_sector||0);break;case"fort_defense":o=l.calcByFormula(spec_wear),u=(spec_wear.fort_defense||0)+(spec_wear.fort_defense_sector||0);break;default:o=l.calcByFormula(spec_wear)}s.push({item:n,id:n.getId(),base_id:n.getItemBaseId(),value:o,special:u})}if(r[i]=s.sort(function(t,r){return e?t.value||t.special?r.value||r.special?r.special-t.special||r.value-t.value:-1:1:r.value-t.value}),r[i].length){var c=r[i][0];if("right_arm"===i){var f=r[i].filter(function(e){return e.value===c.value&&e.item.sub_type===t});a.push(f.length?f[0].item:c.item)}else a.push(c.item)}}),a},beatsBestItems:function(e,t){var r,a,s=e.getUsedSlots(),i={};for(a=0;a<t.length;a++)if(-1!==s.indexOf(t[a].getType())){var n=this.getItemValue(t[a],!0);for(var l in n)i[l]||(i[l]=0),i[l]+=n[l]}return r=this.calcByFormula(i),this.getValue4Set(e)>r},itemsCombineable:function(e){var t,r,a={};for(t=0;t<e.length;t++){if(!0===a[r=ItemManager.get(e[t]).type])return!1;a[r]=!0}return!0},createCombinations:function(e,t){var r,a,s,i,n;if(t>e.length||t<=0)return[];if(t==e.length)return[e];if(1==t){for(s=[],r=0;r<e.length;r++)s.push([e[r]]);return s}for(s=[],r=0;r<e.length-t+1;r++)for(i=e.slice(r,r+1),n=this.createCombinations(e.slice(r+1),t-1),a=0;a<n.length;a++)s.push(i.concat(n[a]));return s},sortSetItems:function(e){var t=ItemManager.get,r=this;e.items.sort(function(e,a){return r.calcByFormula(r.getItemValue(t(a),!0))-r.calcByFormula(r.getItemValue(t(e),!0))})},filterWeapons:function(e){for(var t,r=[],a=0;a<e.length;a++){var s=ItemManager.get(e[a]);"right_arm"===s.type&&r.push(e[a]),"right_arm"===s.type&&s.sub_type!==this.query.weapon&&(t=e[a])}return!r.length||r.length<2?e:e.filter(function(e){return e!==t})},createSubsets:function(e,t,r){this.query.skills;var a,s,i,n,l,o,u,c=this.query.primary,f=[];for(a=0;a<e.length;a++)for(s=e[a],r&&!c&&this.sortSetItems(s),i=s.items.length;i>0;i--)if(s.bonus.hasOwnProperty(i)){var h=this.filterWeapons(s.items);for(l=0,o=(n=r&&!c?[s.items.slice(0,i)]:this.createCombinations(h,i)).length;l<o;l++)this.itemsCombineable(n[l])&&(u=new west.item.ItemSet({key:s.key,items:n[l],bonus:s.bonus}),this.beatsBestItems(u,t)&&f.push(u))}return f},filterUneffectiveSets:function(e){var t,r,a,s=[],i={},n={};for(t=0;t<e.length;t++)n=this.getSetValue(e[t],!0),this.calcByFormula(n)<1||(i[r=JSON.stringify(e[t].getUsedSlots().sort())]?(a=this.getValue4Set(e[t]),this.getValue4Set(i[r])<a&&(i[r]=e[t])):i[r]=e[t]);for(t in i)s.push(i[t]);return s}},TWIR_calc.query=TWIR_calc.getQuery()}(window);
