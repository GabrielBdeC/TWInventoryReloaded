window,TWIR_calc={_memo:{},getPreset:function(){return{skills:{},sort:void 0,weapon:"none",side:"attack",level:Character.level,reset:function(){Object.assign(this,TWIR_calc.getPreset())}}},calcBest:function(e){var t=this;this.getBestSet(function(s){t.fullResult=s,t.result=t.reduceResults(s),t.preset.sort&&t.sortResult(t.preset.sort),e(t.result)})},sortResult:function(e){this.result.sort(function(t,s){return t.stats[e]?s.stats[e]?s.stats[e]-t.stats[e]||s.tmp-t.tmp:1:-1})},getUsedItems:function(e,t){if("object"!=typeof e)return new Array;var s=e.items.slice(0);for(n=0;n<e.sets.length;n++)s.push.apply(s,e.sets[n].getItems());for(var r,a,i=[],n=0;n<s.length;n++)(r=Bag.getItemByItemId(s[n]))?!(a=Wear.get(r.getType()))||a&&(a.getItemBaseId()!==r.getItemBaseId()||a.getItemLevel()<r.getItemLevel())?i.push(t?r.getItemBaseId():r.getId()):i.push(t?a.getItemBaseId():a.getId()):i.push(t?parseInt(s[n]/1e3):s[n]);return i},getBestSet:function(e){var t=this,s=this.preset.skills,r=["fort_offense","fort_defense","fort_damage","fort_resistance","fort_hp"];if("object"==typeof s&&$.isEmptyObject(s))return e(new Array);var a,i,n,l,o,u,f=0;for(u=west.item.Calculator.filterUnavailableSets(west.storage.ItemSetManager.getAll()),a=this.getBestItems(),i=new west.item.ItemSetContainer,l=0;l<a.length;l++)i.addItem(a[l].getId());for((n=this.createSubsets(u,a)).length>500&&"object"==typeof s&&(n=this.createSubsets(u,a,!0),console.log("using approximation...")),n=this.filterUneffectiveSets(n),(n=west.item.Calculator.fillEmptySlots(west.item.Calculator.combineSets(n),a)).push(i),l=0;l<n.length;l++){n[l]=this.itemsToSets(n[l]);var c=this.getValue4Container(n[l],!0);o=this.ignoreDefault(this.calcByFormula(c)),n[l].tmp=o,o>f&&(f=o,n[l]),"string"==typeof s&&r.includes(s)&&(n[l].stats={},$.each(r,function(e,s){n[l].stats[s]=t.calcByFormula(c,s)}))}return e(n),n},getBestOwnItems:function(e){var t=Bag.getItemsByItemIds(TWIR.makeEmUp(e)),s=[];for(var r in Wear.wear)e.includes(Wear.wear[r].getItemBaseId())&&t.push(Wear.wear[r]);for(var a={},i=0;i<t.length;i++){var n=t[i].getType();a[n]?a[n]&&t[i].getItemLevel()>a[n].getItemLevel()&&(a[n]=t[i]):a[n]=t[i]}for(var l in a)s.push(a[l].getId());return s},countObjectKeys:function(e){var t=0;return Object&&Object.keys?t=Object.keys(e).length:jpreset.each(e,function(){t++}),t},isBaseId:function(e){for(var t=e.toString().substr(-3),s=0;s<=5;s++){var r=("000"+(s||0).toString()).slice(-3);if(t.match(r))return!1}return!0},bonusFromItems:function(e,t){for(var s,r=r={items:e,sets:[]},a=this.itemsToSets(r),i=new west.item.ItemSetContainer,n=0;n<a.items.length;n++)i.addItem(a.items[n]);for(var l=0;l<a.sets.length;l++)i.addSet(a.sets[l]);return s=this.getValue4Container(i,!1,t),this.mergeBonus(s)},bonusFromSet:function(e,t){for(var s=west.storage.ItemSetManager.get(e.key),r=this.getSetValue(s,!1,t),a=e.items,i=0;i<a.length;i++){var n=this.getItemValue(ItemManager.get(a[i]*(this.isBaseId(a[i])?1e3:1)),!1,t);for(var l in n)r[l]||(r[l]=0),r[l]+=n[l]}return this.mergeBonus(r)},exportFullBonus:function(e,t,s,r){if(!$.isEmptyObject(e)){var a={};if(t)a=this.getValue4Container(e,!1,r);else{var i=west.storage.ItemSetManager.get(e.key);a=this.getSetValue(i,!1,r);for(var n=e.items,l=0;l<n.length;l++){var o=this.getItemValue(ItemManager.get(n[l]*(s?1e3:1)),!1,r);for(var u in o)a[u]||(a[u]=0),a[u]+=o[u]}}return this.mergeBonus(a)}},mergeBonus:function(e){var t=["experience","dollar","drop","luck"],s={skill:{},attribute:{},fortbattle:{},job:{},income:{},other:{}};for(var r in e)switch(!0){case-1!==r.indexOf("job_"):s.job[r.replace(/\D/g,"")]=e[r];break;case"job"===r:s.job[r]=e[r];break;case-1!==r.indexOf("fort_"):s.fortbattle[r]=e[r];break;case CharacterSkills.allSkillKeys.includes(r):s.skill[r]=e[r];break;case CharacterSkills.allAttrKeys.includes(r):s.attribute[r]=e[r];break;case t.includes(r):s.income[r]=e[r];break;default:s.other[r]=e[r]}return s},getAdditionalBonus:function(e,t,s){s=s||(this.preset.level?this.preset.level:Character.level);var r=new west.item.BonusExtractor({level:s},t);switch("character"===e.type?(value=r.getCharacterItemValue(e),(e=e.bonus).type in r.keyDescMapping&&(value=Math.round(100*value))):e.type in r.keyDescMapping?(value=r.getValue(e),value=Math.round(100*value)):value=r.getValue(e),e.type){case"skill":case"attribute":key=e.name;break;case"fortbattle":key="fort_"+e.name+(e.isSector?"_sector":"");break;case"job":key=e.type+(e.job&&"all"===e.job?"":"_"+e.job);break;default:key=e.type}return{key:key,value:value}},getItemValue:function(e,t,s){s=s||(this.preset.level?this.preset.level:Character.level);var r,a,i=this.preset.skills,n=new west.item.BonusExtractor({level:s},e.getItemLevel()),l={},o=[],u=e.short+"_"+e.getItemLevel()+"_"+s+"_"+JSON.stringify(this.preset)+"_"+t;if(this._memo[u])return this._memo[u];function f(e,t){"damage"!==e&&(l[e]=l[e]||0,l[e]+=t)}function c(e,t){return!!CharacterSkills.allAttrKeys.includes(e)||!t&&!!CharacterSkills.allSkillKeys.includes(e)}if(e.speed&&f("ms",Math.round(1/e.speed*100-100)),e instanceof west.item.Weapon&&(f(e.type+"_damage_min",e.getDamage({level:s}).min),f(e.type+"_damage_max",e.getDamage({level:s}).max)),"object"==typeof e.bonus.attributes&&this.countObjectKeys(e.bonus.attributes)>0)for(var h in e.bonus.attributes)if(t&&e.bonus.attributes[h]){"object"==typeof i&&h in i&&f(h,e.bonus.attributes[h]),o=CharacterSkills.getSkillKeys4Attribute(h);for(var m=0;m<o.length;m++)f(o[m],e.bonus.attributes[h])}else!t&&e.bonus.attributes[h]&&f(h,e.bonus.attributes[h]);if("object"==typeof e.bonus.skills&&this.countObjectKeys(e.bonus.skills)>0)for(var h in e.bonus.skills)e.bonus.skills[h]&&f(h,e.bonus.skills[h]);if(e.bonus.item.length)for(h=0;h<e.bonus.item.length;h++){if(r=n.getAffectedSkills(e.bonus.item[h]),a=this.getAdditionalBonus(e.bonus.item[h],e.getItemLevel(),s),t)for(skill in r)f(skill,r[skill]);(!t||!c(a.key)||t&&c(a.key,!0)&&"object"==typeof i&&a.key in i)&&f(a.key,a.value)}return(e.usebonus||e.action)&&(l={}),this._memo[u]=l,l},reduceResults:function(e){if(!$.isArray(e)||!e.length)return new Array;var t=[];function s(e,t){return e-t==0?0:100*Math.abs((e-t)/t)}e.sort(function(e,t){return t.tmp-e.tmp});for(var r=0;r<e.length;r++)s(e[0].tmp,e[r].tmp)>25||t.length&&this.matchResults(e[r],t,!0)||t.push(e[r]);return t},matchResults:function(e,t){for(var s=this.getUsedItems(e),r=0;r<t.length;r++){var a=this.getUsedItems(t[r]);if(!s.filter(function(e){return!a.includes(e)}).length)return!0}return!1},round:function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},ignoreDefault:function(e){switch("string"==typeof this.preset.skills?this.preset.skills:void 0){case"fort_offense":if(25==e)return 0;break;case"fort_defense":if(10==e)return 0}return e},calcByFormula:function(e,t){function s(e){return CharacterSkills.getSkill(e).points}if(!Object.values(e).length)return 0;var r=this.preset.skills,a=Premium.hasBonus("character"),i=Math.pow((e.leadership?e.leadership+s("leadership"):0)*("soldier"==Character.charClass?a?1.5:1.25:1),.5),n=Math.pow(e.pitfall?e.pitfall+s("pitfall"):0,.6),l=Math.pow(e.hide?e.hide+s("hide"):0,.6),o=Math.pow(e.dodge?e.dodge+s("dodge"):0,.5),u=Math.pow(e.aim?e.aim+s("aim"):0,.5),f=(e.fort_damage||0)+(e.fort_damage_sector||0),c="worker"==Character.charClass?a?1.4:1.2:1,h="worker"==Character.charClass?a?10:5:0,m=0,g=this.preset,p=((e.health||0)+s("health"))*("soldier"==Character.charClass?a?20:15:10)+10*this.preset.level+90;switch(t||("string"==typeof r?r:void 0)){case"ms":m+=(100+(e.ride||0)+(e.ms||0)+s("ride"))*(1+(e.speed||0)/100),e.ride||e.speed||(m=0);break;case"fort_resistance":m+=this.round(300*("attack"==g.side?e.hide||0:e.pitfall||0)/p+(e.fort_resistance||0),2);break;case"fort_offense":m+=this.round((25+i+u+("attack"==g.side?l:n)+(e.fort_offense||0)+(e.fort_offense_sector||0))*c,2);break;case"fort_defense":m+=this.round((10+i+o+("attack"==g.side?l:n)+(e.fort_defense||0)+(e.fort_defense_sector||0))*c,2);break;case"fort_damage":m+=Math.round((e.left_arm_damage_min||0)+f+((e.left_arm_damage_min||0)+f)*(e.leadership||0)/p);break;case"fort_hp":m+=p||0;break;case"construct":m+=Math.floor((3*((e.build||0)+s("build"))+(e.repair||0)+s("repair")+(e.leadership||0)+s("leadership"))/100*(100+h))+(e.job||0);break;default:if("object"==typeof r)for(var v in r)e[v]&&(m+=r[v]*(e[v]||0))}return(isNaN(m)||m<1)&&(m=0),m},getValue4Set:function(e,t){var s={};s=this.getSetValue(e,!0);for(var r=e.items,a=0;a<r.length;a++){var i=this.getItemValue(ItemManager.get(r[a]*(this.isBaseId(r[a])?1e3:1)),!0);for(var n in i)s[n]||(s[n]=0),s[n]+=i[n]}return t?s:this.ignoreDefault(this.calcByFormula(s))},getSetValue:function(e,t,s){s=s||(this.preset.level?this.preset.level:Character.level);var r=this.preset.skills,a=new west.item.BonusExtractor({level:s}),i={},n=e.getMergedStages();function l(e,t){"damage"!==e&&(i[e]=i[e]||0,i[e]+=t)}function o(e,t){return!!CharacterSkills.allAttrKeys.includes(e)||!t&&!!CharacterSkills.allSkillKeys.includes(e)}for(var u=0;u<n.length;u++){if(affectedSkills=a.getAffectedSkills(n[u]),specialSkills=this.getAdditionalBonus(n[u],0,s),t)for(skill in affectedSkills)l(skill,affectedSkills[skill]);(!t||!o(specialSkills.key)||t&&o(specialSkills.key,!0)&&"object"==typeof r&&specialSkills.key in r)&&l(specialSkills.key,specialSkills.value)}return i},getValue4Container:function(e,t,s){var r,a={},i=e.getItems();for(r=0;r<i.length;r++){var n=this.getItemValue(ItemManager.get(i[r]),t,s);for(var l in n)a[l]||(a[l]=0),a[l]+=n[l]}for(var l in n=this.getSetValue4Container(e,t,s))a[l]||(a[l]=0),a[l]+=n[l];return a},getSetValue4Container:function(e,t,s){var r,a={};for(r=0;r<e.sets.length;r++){var i=this.getSetValue(e.sets[r],t,s);for(var n in i)a[n]||(a[n]=0),a[n]+=i[n]}return a},itemsToSets:function(e){for(var t={},s=e.items,r=[],a=0;a<s.length;a++){var i=ItemManager.get(s[a]);if(i.set)if(t[i.set])t[i.set].items.push(i.getId());else{var n=west.storage.ItemSetManager.get(i.set);t[i.set]=new west.item.ItemSet({key:n.key,items:[i.getId()],bonus:n.bonus})}else r.push(i.getId())}for(var l in t)-1===e.sets.findIndex(function(e){return e.key===l})&&e.sets.push(t[l]);return e.items=r,e},filterBoni:function(e,t){var s=this.preset.skills,r={};switch("string"==typeof s?s:void 0){case"ms":r.tmp=(e.ride||0)+(e.ms||0),r.val=e.speed||0;break;case"fort_resistance":r.tmp=this.calcByFormula(e),r.val=e.fort_resistance||0;break;case"fort_offense":r.tmp=this.ignoreDefault(this.calcByFormula(e)),r.val=(e.fort_offense||0)+(e.fort_offense_sector||0),t&&(r.val=0);break;case"fort_defense":r.tmp=this.ignoreDefault(this.calcByFormula(e)),r.val=(e.fort_defense||0)+(e.fort_defense_sector||0),t&&(r.val=0);break;default:r.tmp=this.calcByFormula(e),r.val=0}return r},getBestItems:function(){var e=this.preset.weapon,t={},s=[],r=Bag.getItemsIdsByBaseItemIds(),a=this;return west.common.forEach(r,function(e,s){var r=ItemManager.get(e[0]),i=r.getType(),n=a.getItemValue(r,!0),l=a.filterBoni(n);t[i]=t[i]||[],(l.tmp||l.val)&&r.wearable()&&t[i].push({item:r,id:r.getId(),base_id:s,tmp:l.tmp,val:l.val})}),west.common.forEach(t,function(r,i){var n=Wear.get(i);if(n){n=ItemManager.get(n.getId()),spec=a.getItemValue(n,!0);var l=a.filterBoni(spec);r.push({item:n,id:n.getId(),base_id:n.getItemBaseId(),tmp:l.tmp,val:l.val})}if(t[i]=r.sort(function(e,t){return e.tmp||e.val?t.tmp||t.val?t.val-e.val||t.tmp-e.tmp:-1:1}),t[i].length){var o=t[i][0];if("right_arm"===i&&"none"!==e){var u=t[i].filter(function(t){return t.tmp===o.tmp&&t.item.sub_type===e});s.push(u.length?u[0].item:o.item)}else s.push(o.item)}}),s},beatsBestItems:function(e,t){var s,r,a=e.getUsedSlots(),i={};for(r=0;r<t.length;r++)if(-1!==a.indexOf(t[r].getType())){var n=this.getItemValue(t[r],!0);for(var l in n)i[l]||(i[l]=0),i[l]+=n[l]}return s=this.ignoreDefault(this.calcByFormula(i)),this.getValue4Set(e)>s},itemsCombineable:function(e){var t,s,r={};for(t=0;t<e.length;t++){if(!0===r[s=ItemManager.get(e[t]).type])return!1;r[s]=!0}return!0},createCombinations:function(e,t){var s,r,a,i,n;if(t>e.length||t<=0)return[];if(t==e.length)return[e];if(1==t){for(a=[],s=0;s<e.length;s++)a.push([e[s]]);return a}for(a=[],s=0;s<e.length-t+1;s++)for(i=e.slice(s,s+1),n=this.createCombinations(e.slice(s+1),t-1),r=0;r<n.length;r++)a.push(i.concat(n[r]));return a},sortSetItems:function(e){var t=ItemManager.get,s=this;e.items.sort(function(e,r){return s.calcByFormula(s.getItemValue(t(r),!0))-s.calcByFormula(s.getItemValue(t(e),!0))})},filterWeapons:function(e){if("none"==this.preset.weapon)return e;for(var t,s=[],r=0;r<e.length;r++){var a=ItemManager.get(e[r]);"right_arm"===a.type&&s.push(e[r]),"right_arm"===a.type&&a.sub_type!==this.preset.weapon&&(t=e[r])}return!s.length||s.length<2?e:e.filter(function(e){return e!==t})},createSubsets:function(e,t,s){var r,a,i,n,l,o,u,f=this.preset.skills,c=[];for(r=0;r<e.length;r++)for(a=e[r],s&&"object"==typeof f&&this.sortSetItems(a),i=a.items.length;i>0;i--)if(a.bonus.hasOwnProperty(i)){var h=this.filterWeapons(a.items);for(l=0,o=(n=s&&"object"==typeof f?[a.items.slice(0,i)]:this.createCombinations(h,i)).length;l<o;l++)this.itemsCombineable(n[l])&&(u=new west.item.ItemSet({key:a.key,items:n[l],bonus:a.bonus}),this.beatsBestItems(u,t)&&c.push(u))}return c},filterUneffectiveSets:function(e){for(var t,s,r,a=[],i={},n=0;n<e.length;n++)setValue=this.getSetValue(e[n],!0),setValue=this.filterBoni(setValue,!0),setValue.tmp<1&&setValue.val<1||(t=JSON.stringify(e[n].getUsedSlots().sort()),s=this.getValue4Set(e[n],!0),((r=this.filterBoni(s,!0)).tmp||r.val)&&(i[t]=i[t]||[],i[t].push({set:e[n],tmp:r.tmp,val:r.val})));for(var l in i)i[l]=i[l].sort(function(e,t){return e.tmp||e.val?t.tmp||t.val?t.val-e.val||t.tmp-e.tmp:-1:1}),i[l].length&&a.push(i[l][0].set);return a}},TWIR_calc.preset=TWIR_calc.getPreset();
