!function(e){TWIR_calc={_memo:{},query:{skills:{},primary:void 0,secondary:void 0,mode:"exact",weapon:"shot",side:"attack",level:Character.level},calcBest:function(e){var t=this.getBestSet();return this.result=t,e(t),t},getUsedItems:function(e,t){var a=e.items.slice(0);for(l=0;l<e.sets.length;l++)a.push.apply(a,e.sets[l].getItems());for(var s,r,i=[],l=0;l<a.length;l++)(s=Bag.getItemByItemId(a[l]))?!(r=Wear.get(s.getType()))||r&&(r.getItemBaseId()!==s.getItemBaseId()||r.getItemLevel()<s.getItemLevel())?i.push(t?s.getItemBaseId():s.getId()):i.push(t?r.getItemBaseId():r.getId()):i.push(t?parseInt(a[l]/1e3):a[l]);return i},getBestSet:function(){var t,a,s,r,i,l,n=this,o=0;for(l=west.item.Calculator.filterUnavailableSets(west.storage.ItemSetManager.getAll()),t=this.getBestItems(),a=new west.item.ItemSetContainer,r=0;r<t.length;r++)a.addItem(t[r].getId());for(s=this.createSubsets(l,t),e.__limitclothcalc&&s.length>500&&(s=this.createSubsets(l,t,!0),console&&console.log("using approximation...")),s=this.filterUneffectiveSets(s),(s=west.item.Calculator.fillEmptySlots(west.item.Calculator.combineSets(s),t)).push(a),r=0;r<s.length;r++){s[r]=this.itemsToSets(s[r]);var u=this.getValue4Container(s[r],!0);i=this.calcByFormula(u),s[r].tmp=i,s[r].stats={},$.each(["fort_offense","fort_defense","fort_resistance"],function(e,t){s[r].stats[t]=n.calcByFormula(u,t)}),i>o&&(o=i,s[r])}return s.sort(function(e,t){return t.tmp-e.tmp})},getBestOwnItems:function(e){var t=Bag.getItemsByItemIds(TWIR.makeEmUp(e)),a=[];for(var s in Wear.wear)e.includes(Wear.wear[s].getItemBaseId())&&t.push(Wear.wear[s]);for(var r={},i=0;i<t.length;i++){var l=t[i].getType();r[l]?r[l]&&t[i].getItemLevel()>r[l].getItemLevel()&&(r[l]=t[i]):r[l]=t[i]}for(var n in r)a.push(r[n].getId());return a},countObjectKeys:function(e){var t=0;return Object&&Object.keys?t=Object.keys(e).length:jQuery.each(e,function(){t++}),t},exportFullBonus:function(e,t,a,s){if(!$.isEmptyObject(e)){var r={};if(t)r=this.getValue4Container(e,!1,s);else{var i=west.storage.ItemSetManager.get(e.key);r=this.getSetValue(i,!1,s);for(var l=e.items,n=0;n<l.length;n++){var o=this.getItemValue(ItemManager.get(l[n]*(a?1e3:1)),!1,s);for(var u in o)r[u]||(r[u]=0),r[u]+=o[u]}}return this.mergeBonus(r)}},mergeBonus:function(e){var t=["experience","dollar","drop","luck"],a={skill:{},attribute:{},fortbattle:{},job:{},income:{},other:{}};for(var s in e)switch(!0){case-1!==s.indexOf("job_"):a.job[s.replace(/\D/g,"")]=e[s];break;case"job"===s:a.job[s]=e[s];break;case-1!==s.indexOf("fort_"):a.fortbattle[s]=e[s];break;case CharacterSkills.allSkillKeys.includes(s):a.skill[s]=e[s];break;case CharacterSkills.allAttrKeys.includes(s):a.attribute[s]=e[s];break;case t.includes(s):a.income[s]=e[s];break;default:a.other[s]=e[s]}return a},getAdditionalBonus:function(e,t,a){var s=new west.item.BonusExtractor({level:a||this.query.level},t);switch("character"===e.type?(value=s.getCharacterItemValue(e),(e=e.bonus).type in s.keyDescMapping&&(value=Math.round(100*value))):e.type in s.keyDescMapping?(value=s.getValue(e),value=Math.round(100*value)):value=s.getValue(e),e.type){case"skill":case"attribute":key=e.name;break;case"fortbattle":key="fort_"+e.name+(e.isSector?"_sector":"");break;case"job":key=e.type+(e.job&&"all"===e.job?"":"_"+e.job);break;default:key=e.type}return{key:key,value:value}},getItemValue:function(e,t,a){var s,r,i,l=new west.item.BonusExtractor({level:a||this.query.level},e.getItemLevel()),n={},o=[],u=e.short+"_"+e.getItemLevel()+"_"+JSON.stringify(this.query);if(this._memo[u])return this._memo[u];function c(e,t){"damage"!==e&&(n[e]=n[e]||0,n[e]+=t)}if(e.speed&&c("ms",Math.round(1/e.speed*100-100)),e instanceof west.item.Weapon&&(c(e.type+"_damage_min",e.getDamage({level:a||this.query.level}).min),c(e.type+"_damage_max",e.getDamage({level:a||this.query.level}).max)),"object"==typeof e.bonus.attributes&&this.countObjectKeys(e.bonus.attributes)>0)for(var f in e.bonus.attributes)if(t&&e.bonus.attributes[f]){o=CharacterSkills.getSkillKeys4Attribute(f);for(var m=0;m<o.length;m++)c([o[m]],e.bonus.attributes[f])}else e.bonus.attributes[f]&&c(f,e.bonus.attributes[f]);if("object"==typeof e.bonus.skills&&this.countObjectKeys(e.bonus.skills)>0)for(var f in e.bonus.skills)e.bonus.skills[f]&&c(f,e.bonus.skills[f]);if(e.bonus.item.length)for(f=0;f<e.bonus.item.length;f++){if(s=l.getAffectedSkills(e.bonus.item[f]),r=this.getAdditionalBonus(e.bonus.item[f],e.getItemLevel(),a),t)for(skill in s)c(skill,s[skill]);t&&(i=r.key,CharacterSkills.allAttrKeys.includes(i)||CharacterSkills.allSkillKeys.includes(i))||c(r.key,r.value)}return(e.usebonus||e.action)&&(n={}),this._memo[u]=n,n},round:function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},calcByFormula:function(e,t){if(!Object.values(e).length)return 0;var a=this.query.skills,s=this.query.primary,r=Premium.hasBonus("character"),i=Math.pow((e.leadership||0)*("soldier"==Character.charClass?r?1.5:1.25:1),.5);f=Math.pow(e.pitfall||0,.6),g=Math.pow(e.hide||0,.6),p=Math.pow(e.dodge||0,.5),q=Math.pow(e.aim||0,.5),b=(e.fort_damage||0)+(e.fort_damage_sector||0),l="worker"==Character.charClass?r?1.4:1.2:1;var n=0,o=this.query,u=((e.health||0)+CharacterSkills.getSkill("health").points)*("soldier"==Character.charClass?r?20:15:10)+10*this.query.level+90;switch(t||s){case"ms":n+=(100+(e.ride||0)+(e.ms||0)+CharacterSkills.getSkill("ride").points)*(1+(e.speed||0)/100);break;case"fort_resistance":n+=this.round(300*("attack"==o.side?e.hide||0:e.pitfall||0)/u+(e.fort_resistance||0),2);break;case"fort_offense":n+=this.round((25+i+q+("attack"==o.side?g:f)+(e.fort_offense||0)+(e.fort_offense_sector||0))*l,2);break;case"fort_defense":n+=this.round((10+i+p+("attack"==o.side?g:f)+(e.fort_defense||0)+(e.fort_defense_sector||0))*l,2);break;case"fort_damage":n+=Math.round((e.left_arm_damage_min||0)+b+((e.left_arm_damage_min||0)+b)*(e.leadership||0)/u);break;default:for(var c in a)e[c]&&(n+=a[c]*(e[c]||0))}return n},getValue4Set:function(e,t){var a={};a=this.getSetValue(e,!0);for(var s=e.items,r=0;r<s.length;r++){var i=this.getItemValue(ItemManager.get(s[r]*(t?1e3:1)),!0);for(var l in i)a[l]||(a[l]=0),a[l]+=i[l]}return this.calcByFormula(a)},getSetValue:function(e,t,a){var s,r=new west.item.BonusExtractor({level:a||this.query.level}),i={},l=e.getMergedStages();function n(e,t){"damage"!==e&&(i[e]=i[e]||0,i[e]+=t)}for(var o=0;o<l.length;o++){if(affectedSkills=r.getAffectedSkills(l[o]),specialSkills=this.getAdditionalBonus(l[o],0,a),t)for(skill in affectedSkills)n(skill,affectedSkills[skill]);t&&(s=specialSkills.key,CharacterSkills.allAttrKeys.includes(s)||CharacterSkills.allSkillKeys.includes(s))||n(specialSkills.key,specialSkills.value)}return i},getValue4Container:function(e,t,a){var s,r={},i=e.getItems();for(s=0;s<i.length;s++){var l=this.getItemValue(ItemManager.get(i[s]),t,a);for(var n in l)r[n]||(r[n]=0),r[n]+=l[n]}for(var n in l=this.getSetValue4Container(e,t,a))r[n]||(r[n]=0),r[n]+=l[n];return r},getSetValue4Container:function(e,t,a){var s,r={};for(s=0;s<e.sets.length;s++){var i=this.getSetValue(e.sets[s],t,a);for(var l in i)r[l]||(r[l]=0),r[l]+=i[l]}return r},itemsToSets:function(e){for(var t={},a=e.items,s=[],r=0;r<a.length;r++){var i=ItemManager.get(a[r]);if(i.set)if(t[i.set])t[i.set].items.push(i.getId());else{var l=west.storage.ItemSetManager.get(i.set);t[i.set]=new west.item.ItemSet({key:l.key,items:[i.getId()],bonus:l.bonus})}else s.push(i.getId())}for(var n in t)-1===e.sets.findIndex(function(e){return e.key===n})&&e.sets.push(t[n]);return e.items=s,e},getBestItems:function(){this.query.skills;var e=this.query.primary,t=this.query.weapon,a={},s=[],r=0,i=0,l=Bag.getItemsIdsByBaseItemIds(),n=this;west.common.forEach(l,function(t,s){var l,o=ItemManager.get(t[0]),u=o.getType();switch(l=n.getItemValue(o,!0),e){case"ms":r=(l.ride||0)+(l.ms||0),i=l.speed||0;break;case"fort_resistance":r="attack"==n.query.side?l.hide||0:l.pitfall||0,i=l.fort_resistance||0;break;case"fort_offense":r=n.calcByFormula(l),i=(l.fort_offense||0)+(l.fort_offense_sector||0);break;case"fort_defense":r=n.calcByFormula(l),i=(l.fort_defense||0)+(l.fort_defense_sector||0);break;default:r=n.calcByFormula(l)}a[u]=a[u]||[],r&&o.wearable()&&a[u].push({item:o,id:o.getId(),base_id:s,value:r,special:i})});var o=0,u=0;return west.common.forEach(a,function(r,i){var l=Wear.get(i);if(l){switch(l=ItemManager.get(l.getId()),spec_wear={},spec_wear=n.getItemValue(l,!0),e){case"ms":o=(spec_wear.ride||0)+(spec_wear.ms||0),u=spec_wear.speed||0;break;case"fort_resistance":o="attack"==n.query.side?spec_wear.hide||0:spec_wear.pitfall||0,u=spec_wear.fort_resistance||0;break;case"fort_offense":o=n.calcByFormula(spec_wear),u=(spec_wear.fort_offense||0)+(spec_wear.fort_offense_sector||0);break;case"fort_defense":o=n.calcByFormula(spec_wear),u=(spec_wear.fort_defense||0)+(spec_wear.fort_defense_sector||0);break;default:o=n.calcByFormula(spec_wear)}r.push({item:l,id:l.getId(),base_id:l.getItemBaseId(),value:o,special:u})}if(a[i]=r.sort(function(t,a){return e?t.value||t.special?a.value||a.special?a.special-t.special||a.value-t.value:-1:1:a.value-t.value}),a[i].length){var c=a[i][0];if("right_arm"===i){var f=a[i].filter(function(e){return e.value===c.value&&e.item.sub_type===t});s.push(f.length?f[0].item:c.item)}else s.push(c.item)}}),s},beatsBestItems:function(e,t){var a,s,r=e.getUsedSlots(),i={};for(s=0;s<t.length;s++)if(-1!==r.indexOf(t[s].getType())){var l=this.getItemValue(t[s],!0);for(var n in l)i[n]||(i[n]=0),i[n]+=l[n]}return a=this.calcByFormula(i),this.getValue4Set(e)>a},itemsCombineable:function(e){var t,a,s={};for(t=0;t<e.length;t++){if(!0===s[a=ItemManager.get(e[t]).type])return!1;s[a]=!0}return!0},createCombinations:function(e,t){var a,s,r,i,l;if(t>e.length||t<=0)return[];if(t==e.length)return[e];if(1==t){for(r=[],a=0;a<e.length;a++)r.push([e[a]]);return r}for(r=[],a=0;a<e.length-t+1;a++)for(i=e.slice(a,a+1),l=this.createCombinations(e.slice(a+1),t-1),s=0;s<l.length;s++)r.push(i.concat(l[s]));return r},sortSetItems:function(e){var t=ItemManager.get,a=this;e.items.sort(function(e,s){return a.calcByFormula(a.getItemValue(t(s),!0))-a.calcByFormula(a.getItemValue(t(e),!0))})},filterWeapons:function(e){for(var t,a=[],s=0;s<e.length;s++){var r=ItemManager.get(e[s]);"right_arm"===r.type&&a.push(e[s]),"right_arm"===r.type&&r.sub_type!==this.query.weapon&&(t=e[s])}return!a.length||a.length<2?e:e.filter(function(e){return e!==t})},createSubsets:function(e,t,a){this.query.skills;var s,r,i,l,n,o,u,c=this.query.primary,f=[];for(s=0;s<e.length;s++)for(r=e[s],a&&!c&&this.sortSetItems(r),i=r.items.length;i>0;i--)if(r.bonus.hasOwnProperty(i)){var m=this.filterWeapons(r.items);for(n=0,o=(l=a&&!c?[r.items.slice(0,i)]:this.createCombinations(m,i)).length;n<o;n++)this.itemsCombineable(l[n])&&(u=new west.item.ItemSet({key:r.key,items:l[n],bonus:r.bonus}),this.beatsBestItems(u,t)&&f.push(u))}return f},filterUneffectiveSets:function(e){this.query.skills,this.query.primary;var t,a,s,r=[],i={},l={};for(t=0;t<e.length;t++)l=this.getSetValue(e[t],!0),this.calcByFormula(l)<1||(i[a=JSON.stringify(e[t].getUsedSlots().sort())]?(s=this.getValue4Set(e[t]),this.getValue4Set(i[a])<s&&(i[a]=e[t])):i[a]=e[t]);for(t in i)r.push(i[t]);return r}}}(window);
